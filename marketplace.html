<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialTrade Elite Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-active { color: #2563eb !important; background: #eff6ff; border-radius: 1.5rem; }
        .premium-card { background: white; border-radius: 2.5rem; border: 1px solid rgba(0,0,0,0.03); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05); }
        .custom-select { appearance: none; background: #fff; border: 1px solid #eef2f6; border-radius: 1rem; padding: 12px 20px; font-size: 11px; font-weight: 800; color: #64748b; cursor: pointer; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 1rem center; background-repeat: no-repeat; background-size: 1.2em; }
        .item-chk:checked + label { border-color: #2563eb; background: #f0f7ff; }
    </style>
</head>
<body class="pb-32">

    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-gray-100 px-6 py-5 flex justify-between items-center">
        <h1 id="pageTitle" class="text-xl font-black text-gray-900 tracking-tighter italic uppercase">Marketplace</h1>
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white px-4 py-2 rounded-2xl text-[10px] font-black shadow-lg">
                ৳ <span id="topBalance">0.00</span>
            </div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto px-5 mt-6">
        
        <section id="marketTab" class="tab-content active space-y-6">
            <div class="flex gap-2">
                <select id="typeFilter" onchange="loadMarket()" class="custom-select flex-1">
                    <option value="All">Buy/Sell: All</option>
                    <option value="Seller">I'm Selling</option>
                    <option value="Buyer">I'm Buying</option>
                </select>
                <select id="platformFilter" onchange="loadMarket()" class="custom-select flex-1">
                    <option value="All">All Socials</option>
                    <option value="Gmail">Gmail</option>
                    <option value="Facebook">Facebook</option>
                    <option value="WhatsApp">WhatsApp</option>
                </select>
            </div>
            <div id="marketContainer" class="space-y-6"></div>
        </section>

        <section id="draftTab" class="tab-content space-y-4">
            <select id="statusFilter" onchange="loadOrders()" class="custom-select w-full">
                <option value="all">Filter: All History</option>
                <option value="pending">Pending</option>
                <option value="confirmed">Successful</option>
                <option value="rejected">Rejected</option>
            </select>
            <div id="draftContainer" class="space-y-4"></div>
        </section>

        <section id="msgTab" class="tab-content space-y-4">
            <div class="flex justify-between items-center mb-2 px-2">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest italic">Trade Messages</p>
                <input type="date" id="dateFilter" onchange="loadMessages()" class="custom-select py-2">
            </div>
            <div id="msgContainer" class="space-y-4"></div>
        </section>

        <section id="profileTab" class="tab-content">
            <div class="mb-8">
                <h1 class="text-2xl font-black text-gray-800 tracking-tighter">Welcome, <span id="displayFullName" class="text-blue-600">User</span>!</h1>
                <p class="text-gray-500 text-xs font-bold uppercase tracking-widest mt-1">Personal Dashboard</p>
            </div>

            <div class="grid grid-cols-1 gap-6 mb-8">
                <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-[2.5rem] p-8 text-white shadow-xl shadow-blue-100 relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-blue-100 text-[10px] font-black uppercase tracking-widest">Available Balance</p>
                        <h2 class="text-4xl font-black mt-2 italic text-white">৳<span id="userBalance">0.00</span></h2>
                        <div class="mt-6 flex items-center text-[10px] font-black bg-white/20 w-fit px-4 py-2 rounded-full uppercase">
                            <i class="fas fa-shield-alt mr-2"></i> Verified Wallet
                        </div>
                    </div>
                    <i class="fas fa-wallet absolute -bottom-6 -right-6 text-[10rem] text-white/10"></i>
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] shadow-sm border border-gray-50 overflow-hidden mb-6">
                <div class="p-8 space-y-6">
                    <div class="flex items-center space-x-4">
                        <div class="h-12 w-12 bg-orange-50 text-orange-500 rounded-2xl flex items-center justify-center text-xl"><i class="fas fa-fingerprint"></i></div>
                        <div><p class="text-gray-400 text-[9px] font-black uppercase tracking-widest">Account ID</p><h3 id="displayUserId" class="text-sm font-black text-gray-800">ST_WAIT</h3></div>
                    </div>
                    <div class="grid grid-cols-1 gap-6 pt-6 border-t border-gray-50">
                        <div><p class="text-gray-400 text-[9px] font-black uppercase tracking-widest mb-1">Email Address</p><p id="displayEmail" class="text-xs font-bold text-gray-700 italic">...</p></div>
                        <div class="flex justify-between">
                            <div><p class="text-gray-400 text-[9px] font-black uppercase tracking-widest mb-1">Country</p><p id="displayCountry" class="text-xs font-bold text-gray-700 italic">...</p></div>
                            <div class="text-right"><p class="text-gray-400 text-[9px] font-black uppercase tracking-widest mb-1">Verification</p><p class="text-xs font-black text-green-500 italic uppercase">Verified</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-6 left-6 right-6 bg-white/90 backdrop-blur-xl border border-gray-100 rounded-[2.5rem] p-2 flex justify-between items-center z-50 shadow-2xl">
        <button onclick="changeTab('market', this)" class="nav-btn nav-active flex-1 py-3 text-gray-400 flex flex-col items-center gap-1">
            <i class="fas fa-shop text-lg"></i><span class="text-[8px] font-black uppercase">Store</span>
        </button>
        <button onclick="changeTab('draft', this)" class="nav-btn flex-1 py-3 text-gray-400 flex flex-col items-center gap-1">
            <i class="fas fa-history text-lg"></i><span class="text-[8px] font-black uppercase">History</span>
        </button>
        <button onclick="changeTab('msg', this)" class="nav-btn flex-1 py-3 text-gray-400 flex flex-col items-center gap-1">
            <i class="fas fa-envelope-open-text text-lg"></i><span class="text-[8px] font-black uppercase">Inbox</span>
        </button>
        <button onclick="changeTab('profile', this)" class="nav-btn flex-1 py-3 text-gray-400 flex flex-col items-center gap-1">
            <i class="fas fa-user-circle text-lg"></i><span class="text-[8px] font-black uppercase">Me</span>
        </button>
    </nav>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA",
            authDomain: "social-media-5e6c8.firebaseapp.com",
            databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com/",
            projectId: "social-media-5e6c8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let currentUser = null;

        auth.onAuthStateChanged(user => { 
            if(user) { 
                currentUser = user; 
                syncData(); 
            } else {
                window.location.href = "login.html";
            }
        });

        function syncData() {
            // Profile & Balance Sync
            db.ref('user-info/' + currentUser.uid).on('value', snap => {
                const data = snap.val();
                if(data) {
                    const bal = data.balance ? parseFloat(data.balance).toFixed(2) : "0.00";
                    document.getElementById('topBalance').innerText = bal;
                    document.getElementById('userBalance').innerText = bal;
                    document.getElementById('displayFullName').innerText = data.profile.fullName;
                    document.getElementById('displayEmail').innerText = data.profile.email;
                    document.getElementById('displayUserId').innerText = data.profile.userId || 'N/A';
                    document.getElementById('displayCountry').innerText = data.search_meta.country;
                }
            });
            loadMarket();
            loadOrders();
            loadMessages();
        }

        // --- Same Logic as requested (Market, Order, Approve) ---
        function loadMarket() {
            const container = document.getElementById('marketContainer');
            const typeF = document.getElementById('typeFilter').value;
            const platF = document.getElementById('platformFilter').value;
            
            db.ref('market-items').on('value', snap => {
                container.innerHTML = "";
                if(!snap.val()) return;
                Object.keys(snap.val()).reverse().forEach(id => {
                    const gig = snap.val()[id];
                    if(gig.isHidden) return;
                    if(typeF !== 'All' && gig.publisherType !== typeF) return;

                    let itemsHtml = "";
                    Object.keys(gig.items).forEach(pName => {
                        if(platF !== 'All' && pName !== platF) return;
                        const item = gig.items[pName];
                        itemsHtml += `
                            <div class="relative mb-2">
                                <input type="checkbox" id="chk-${id}-${pName}" class="item-chk hidden" name="items-${id}" value="${pName}" data-price="${item.totalPrice}">
                                <label for="chk-${id}-${pName}" class="flex items-center justify-between p-5 border border-gray-100 rounded-[1.5rem] cursor-pointer bg-white">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-gray-50 rounded-xl flex items-center justify-center text-lg"><i class="${item.icon}"></i></div>
                                        <div><p class="text-[11px] font-black uppercase text-gray-800">${pName}</p><p class="text-[9px] font-bold text-gray-400">${item.quantity} Pcs • ${item.reportTime}h Report</p></div>
                                    </div>
                                    <p class="text-xs font-black text-blue-600">৳${item.totalPrice}</p>
                                </label>
                            </div>`;
                    });
                    if(itemsHtml) {
                        container.innerHTML += `
                            <div class="premium-card p-7">
                                <span class="text-[9px] font-black bg-blue-50 text-blue-600 px-3 py-1 rounded-full uppercase tracking-tighter mb-4 inline-block">${gig.publisherType} POST</span>
                                <h3 class="text-lg font-black text-gray-800 italic mb-5 leading-tight tracking-tighter">${gig.title}</h3>
                                <div class="space-y-1 mb-6">${itemsHtml}</div>
                                <button onclick="sendRequest('${id}', '${gig.publisherId}')" class="w-full bg-gray-900 text-white py-5 rounded-[1.8rem] font-black text-[11px] uppercase tracking-widest active:scale-95 transition-all shadow-xl shadow-gray-200">Request Trade</button>
                            </div>`;
                    }
                });
            });
        }

        async function sendRequest(gigId, ownerId) {
            const sel = document.querySelectorAll(`input[name="items-${gigId}"]:checked`);
            if(sel.length === 0) return Swal.fire('Error', 'Please select at least one item!', 'error');
            let total = 0; let items = [];
            sel.forEach(s => { total += parseFloat(s.dataset.price); items.push(s.value); });

            Swal.fire({ title: 'Confirm Order?', text: `Total: ৳${total}`, showCancelButton: true }).then(async res => {
                if(res.isConfirmed) {
                    await db.ref(`market-items/${gigId}`).update({ isHidden: true });
                    await db.ref('orders').push({ buyerId: currentUser.uid, sellerId: ownerId, items, total, status: 'pending', date: new Date().toISOString().split('T')[0] });
                    Swal.fire('Success', 'Order placed. Check History.', 'success');
                }
            });
        }

        function loadOrders() {
            const container = document.getElementById('draftContainer');
            const statusF = document.getElementById('statusFilter').value;
            db.ref('orders').on('value', snap => {
                container.innerHTML = "";
                if(!snap.val()) return;
                Object.keys(snap.val()).reverse().forEach(id => {
                    const o = snap.val()[id];
                    if(o.buyerId !== currentUser.uid && o.sellerId !== currentUser.uid) return;
                    if(statusF !== 'all' && o.status !== statusF) return;

                    const isOwner = o.sellerId === currentUser.uid;
                    container.innerHTML += `
                        <div class="premium-card p-6 border-l-8 ${o.status==='pending'?'border-l-orange-400':'border-l-green-500'}">
                            <div class="flex justify-between mb-3"><span class="text-[10px] font-black uppercase text-orange-500 italic tracking-tighter">${o.status}</span><p class="text-xs font-black italic">৳${o.total}</p></div>
                            <p class="text-[11px] font-black uppercase text-gray-700 mb-5 leading-tight">${o.items.join(' + ')}</p>
                            ${isOwner && o.status === 'pending' ? `<button onclick="approveDeal('${id}')" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-blue-100">APPROVE & SEND DETAILS</button>` : ''}
                        </div>`;
                });
            });
        }

        async function approveDeal(oid) {
            const { value: text } = await Swal.fire({ title: 'Account Details', input: 'textarea', inputPlaceholder: 'Enter account info for buyer...', showCancelButton: true });
            if(text) await db.ref(`orders/${oid}`).update({ status: 'confirmed', sellerMsg: text });
        }

        function loadMessages() {
            const container = document.getElementById('msgContainer');
            const dateF = document.getElementById('dateFilter').value;
            db.ref('orders').on('value', snap => {
                container.innerHTML = "";
                if(!snap.val()) return;
                Object.keys(snap.val()).reverse().forEach(id => {
                    const o = snap.val()[id];
                    if(o.buyerId !== currentUser.uid || !o.sellerMsg) return;
                    if(dateF && o.date !== dateF) return;

                    container.innerHTML += `
                        <div class="premium-card p-7 bg-white border-2 border-blue-50">
                            <p class="text-[10px] font-black text-blue-600 uppercase mb-4 italic tracking-widest">Trade Messagepaw</p>
                            <div class="bg-blue-50/50 p-5 rounded-3xl text-[11px] font-bold text-gray-700 italic mb-5 whitespace-pre-wrap border border-blue-100/30">${o.sellerMsg}</div>
                            <div class="flex gap-3">
                                <button class="flex-1 bg-green-600 text-white py-4 rounded-2xl text-[11px] font-black uppercase tracking-widest shadow-lg">HAPPY</button>
                                <button class="flex-1 bg-red-50 text-red-600 py-4 rounded-2xl text-[11px] font-black uppercase tracking-widest">REPORT</button>
                            </div>
                        </div>`;
                });
            });
        }

        function changeTab(tab, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            btn.classList.add('nav-active');
            document.getElementById('pageTitle').innerText = tab === 'market' ? 'Marketplace' : tab.toUpperCase();
        }
    </script>
</body>
</html>