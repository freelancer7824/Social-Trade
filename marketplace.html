<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialTrade Elite - Multi-Select Escrow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .premium-card { background: white; border-radius: 2.2rem; border: 1px solid rgba(0,0,0,0.03); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.02); }
        .nav-active { color: #2563eb !important; background: #eff6ff; border-radius: 1.5rem; }
        .item-chk:checked + label { border-color: #2563eb; background: #f0f7ff; }
    </style>
</head>
<body class="pb-32">

    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-gray-100 px-6 py-5 flex justify-between items-center">
        <h1 id="pageTitle" class="text-xl font-black text-gray-900 italic tracking-tighter">STORE</h1>
        <div class="bg-blue-600 text-white px-4 py-2 rounded-2xl text-[10px] font-black shadow-lg">
            ৳ <span id="userBalance">0.00</span>
        </div>
    </header>

    <main class="max-w-xl mx-auto px-5 mt-6">
        
        <section id="marketTab" class="tab-content active space-y-6">
            <div id="marketContainer" class="space-y-6"></div>
        </section>

        <section id="notifTab" class="tab-content space-y-4">
            <h2 class="text-[10px] font-black text-gray-400 uppercase tracking-widest px-2">Order Requests</h2>
            <div id="notifContainer" class="space-y-4"></div>
        </section>

        <section id="msgTab" class="tab-content space-y-4">
            <h2 class="text-[10px] font-black text-gray-400 uppercase tracking-widest px-2">Secret Inbox</h2>
            <div id="msgContainer" class="space-y-4"></div>
        </section>

    </main>

    <nav class="fixed bottom-6 left-6 right-6 bg-white border border-gray-100 rounded-[2.5rem] p-2 flex justify-between items-center z-50 shadow-2xl">
        <button onclick="changeTab('market', this)" class="nav-btn nav-active flex-1 py-3 text-gray-400 flex flex-col items-center gap-1">
            <i class="fas fa-shop text-lg"></i><span class="text-[8px] font-black uppercase">Store</span>
        </button>
        <button onclick="changeTab('notif', this)" class="nav-btn flex-1 py-3 text-gray-400 flex flex-col items-center gap-1">
            <i class="fas fa-bell text-lg"></i><span class="text-[8px] font-black uppercase">Notif</span>
        </button>
        <button onclick="changeTab('msg', this)" class="nav-btn flex-1 py-3 text-gray-400 flex flex-col items-center gap-1">
            <i class="fas fa-envelope-open-text text-lg"></i><span class="text-[8px] font-black uppercase">Inbox</span>
        </button>
    </nav>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA",
            authDomain: "social-media-5e6c8.firebaseapp.com",
            databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com/",
            projectId: "social-media-5e6c8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let currentUser = null;

        auth.onAuthStateChanged(user => { if(user) { currentUser = user; startSync(); } });

        function startSync() {
            db.ref(`user-info/${currentUser.uid}/balance`).on('value', s => {
                document.getElementById('userBalance').innerText = (s.val() || 0).toFixed(2);
            });
            loadMarket();
            loadOrders();
        }

        // --- 1. Load Market with Multi-Select ---
        function loadMarket() {
            db.ref('market-items').on('value', snap => {
                const container = document.getElementById('marketContainer');
                container.innerHTML = "";
                if(!snap.val()) return;

                Object.keys(snap.val()).reverse().forEach(id => {
                    const gig = snap.val()[id];
                    if(gig.isHidden) return;

                    let itemsHtml = "";
                    Object.keys(gig.items).forEach(pName => {
                        const item = gig.items[pName];
                        itemsHtml += `
                            <div class="relative mb-2">
                                <input type="checkbox" id="chk-${id}-${pName}" name="order-${id}" value="${pName}" 
                                    data-price="${item.totalPrice}" data-qty="${item.quantity}" data-time="${item.reportTime}" class="item-chk hidden">
                                <label for="chk-${id}-${pName}" class="flex items-center justify-between p-4 border border-gray-100 rounded-2xl cursor-pointer bg-white hover:bg-gray-50 transition-all">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-gray-50 rounded-xl flex items-center justify-center text-blue-600 shadow-sm"><i class="${item.icon}"></i></div>
                                        <div>
                                            <p class="text-[10px] font-black uppercase text-gray-800">${pName}</p>
                                            <p class="text-[8px] font-bold text-gray-400 uppercase tracking-tighter">${item.quantity} Pcs • ${item.reportTime}h Report Time</p>
                                        </div>
                                    </div>
                                    <p class="text-xs font-black text-blue-600 italic">৳${item.totalPrice}</p>
                                </label>
                            </div>`;
                    });

                    container.innerHTML += `
                        <div class="premium-card p-6">
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-[8px] font-black bg-blue-50 text-blue-600 px-3 py-1 rounded-full uppercase tracking-widest">${gig.publisherType} POST</span>
                            </div>
                            <h3 class="text-sm font-black text-gray-800 mb-5 leading-tight italic uppercase tracking-tighter">${gig.title}</h3>
                            <div class="space-y-1 mb-6">${itemsHtml}</div>
                            <button onclick="confirmTransaction('${id}', '${gig.publisherId}')" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest active:scale-95 transition-all shadow-xl shadow-gray-100">CONFIRM SELECTION</button>
                        </div>`;
                });
            });
        }

        // --- 2. Multi-Select Logic & Balance Deduction ---
        async function confirmTransaction(gigId, sellerId) {
            const selectedBoxes = document.querySelectorAll(`input[name="order-${gigId}"]:checked`);
            if(selectedBoxes.length === 0) return Swal.fire('Wait!', 'Select at least one item.', 'warning');

            let total = 0; let itemDetails = [];
            selectedBoxes.forEach(box => {
                total += parseFloat(box.dataset.price);
                itemDetails.push(`${box.value} (${box.dataset.qty} Pcs)`);
            });

            // Check Balance
            const balSnap = await db.ref(`user-info/${currentUser.uid}/balance`).get();
            const currentBal = balSnap.val() || 0;

            if(currentBal < total) return Swal.fire('Error', 'Insufficient balance!', 'error');

            Swal.fire({
                title: 'Proceed Trade?',
                text: `৳${total} will be held in escrow.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#111827'
            }).then(async res => {
                if(res.isConfirmed) {
                    // 1. Deduct Balance from Buyer
                    await db.ref(`user-info/${currentUser.uid}/balance`).set(currentBal - total);
                    // 2. Hide Post from Market
                    await db.ref(`market-items/${gigId}`).update({ isHidden: true });
                    // 3. Create Order Object
                    await db.ref('orders').push({
                        buyerId: currentUser.uid,
                        sellerId: sellerId,
                        items: itemDetails.join(' + '),
                        amount: total,
                        status: 'pending',
                        timestamp: Date.now()
                    });
                    Swal.fire('Success', 'Payment held! Wait for seller details.', 'success');
                }
            });
        }

        // --- 3. Seller Action & Buyer Release (The Flow) ---
        function loadOrders() {
            db.ref('orders').on('value', snap => {
                const notifBox = document.getElementById('notifContainer');
                const msgBox = document.getElementById('msgContainer');
                notifBox.innerHTML = ""; msgBox.innerHTML = "";
                
                if(!snap.val()) return;

                Object.keys(snap.val()).reverse().forEach(id => {
                    const o = snap.val()[id];

                    // Notification for Owner/Seller
                    if(o.sellerId === currentUser.uid && o.status === 'pending') {
                        notifBox.innerHTML += `
                            <div class="premium-card p-6 border-2 border-dashed border-blue-100">
                                <p class="text-[9px] font-black text-blue-600 uppercase mb-2">New Sale Notification</p>
                                <h4 class="text-xs font-black text-gray-800 mb-4">${o.items} - ৳${o.amount}</h4>
                                <div class="flex gap-2">
                                    <button onclick="sellerApprove('${id}')" class="flex-1 bg-gray-900 text-white py-3 rounded-xl text-[9px] font-black uppercase">Approve</button>
                                    <button onclick="db.ref('orders/${id}').update({status:'rejected'})" class="flex-1 bg-red-50 text-red-600 py-3 rounded-xl text-[9px] font-black uppercase">Reject</button>
                                </div>
                            </div>`;
                    }

                    // Inbox for Buyer (Message Box)
                    if(o.buyerId === currentUser.uid && o.status === 'seller_responded') {
                        msgBox.innerHTML += `
                            <div class="premium-card p-7 border-2 border-blue-50 bg-blue-50/20">
                                <p class="text-[9px] font-black text-blue-600 mb-3 uppercase italic tracking-widest">Access Details Received</p>
                                <div class="bg-white p-5 rounded-3xl text-[11px] font-bold text-gray-700 italic mb-6 border border-blue-100 whitespace-pre-wrap">${o.sellerMsg}</div>
                                <div class="flex gap-3">
                                    <button onclick="buyerFinalRelease('${id}', ${o.amount}, '${o.sellerId}')" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-lg">Final Release</button>
                                    <button class="flex-1 bg-red-50 text-red-600 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest">Report</button>
                                </div>
                            </div>`;
                    }
                });
            });
        }

        // Seller Response Logic
        async function sellerApprove(orderId) {
            const { value: text } = await Swal.fire({
                title: 'Response / Account Info',
                input: 'textarea',
                inputPlaceholder: 'Type email:pass or account details here...',
                showCancelButton: true,
                confirmButtonColor: '#2563eb',
                customClass: { popup: 'rounded-[2rem]' }
            });

            if(text) {
                await db.ref(`orders/${orderId}`).update({
                    status: 'seller_responded',
                    sellerMsg: text
                });
                Swal.fire('Sent!', 'Buyer will now verify and release payment.', 'success');
            }
        }

        // Buyer Final Release Logic
        async function buyerFinalRelease(orderId, amount, sellerId) {
            Swal.fire({
                title: 'Release Payment?',
                text: 'This will add ৳' + amount + ' to the seller balance.',
                icon: 'warning',
                showCancelButton: true
            }).then(async res => {
                if(res.isConfirmed) {
                    const selSnap = await db.ref(`user-info/${sellerId}/balance`).get();
                    const currentSelBal = selSnap.val() || 0;
                    
                    // Final Add to Seller
                    await db.ref(`user-info/${sellerId}/balance`).set(currentSelBal + amount);
                    // Finish Deal
                    await db.ref(`orders/${orderId}`).update({ status: 'completed' });
                    
                    Swal.fire('Deal Done!', 'Payment has been released to seller.', 'success');
                }
            });
        }

        function changeTab(tab, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            btn.classList.add('nav-active');
            document.getElementById('pageTitle').innerText = tab.toUpperCase();
        }
    </script>
</body>
</html>
