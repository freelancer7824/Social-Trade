<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbox - SocialTrade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging-compat.js"></script>

    <style>
        body { background-color: white; font-family: 'Segoe UI', sans-serif; }
        .online-dot { width: 14px; height: 14px; background-color: #31a24c; border: 2px solid white; border-radius: 50%; position: absolute; bottom: 2px; right: 2px; }
        .offline-dot { width: 14px; height: 14px; background-color: #bec3c9; border: 2px solid white; border-radius: 50%; position: absolute; bottom: 2px; right: 2px; }
        .chat-item:active { background-color: #f3f4f6; }
    </style>
</head>
<body class="max-w-[500px] mx-auto h-screen flex flex-col">

    <div class="p-4 flex items-center justify-between border-b sticky top-0 bg-white z-10">
        <h1 class="text-2xl font-bold">Chats</h1>
        <i class="fas fa-edit text-xl text-gray-700"></i>
    </div>

    <div id="chat-list" class="flex-1 overflow-y-auto">
        <div class="p-10 text-center text-gray-400">Loading your conversations...</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA",
            authDomain: "social-media-5e6c8.firebaseapp.com",
            databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com/",
            projectId: "social-media-5e6c8",
            storageBucket: "social-media-5e6c8.firebasestorage.app",
            messagingSenderId: "897473713729",
            appId: "1:897473713729:web:7ba552ed4c1be8754418c0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const messaging = firebase.messaging();

        let myUid = "";
        let swReg = null;
        let lastTimestamp = Date.now();

        // ১. সার্ভিস ওয়ার্কার ও টোকেন সেটআপ
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('firebase-messaging-sw.js').then((registration) => {
                swReg = registration;
                console.log("SW Registered");
                
                return messaging.getToken({ 
                    vapidKey: 'BGRd4banTjefAHDqas1og2DDK2zMIZVZQovcI4UXjFXJuNOo6Ug-qYEhTFaurdd_A_tfu8FNvXBa6iNICN1hQao',
                    serviceWorkerRegistration: registration 
                });
            }).then((token) => {
                if (token && myUid) db.ref(`user-info/${myUid}/fcmToken`).set(token);
            });
        }

        // ২. ইউজার স্ট্যাটাস হ্যান্ডলার
        function setOnlineStatus(uid) {
            const statusRef = db.ref(`status/${uid}`);
            db.ref('.info/connected').on('value', (snap) => {
                if (snap.val() === true) {
                    statusRef.onDisconnect().set({ state: 'offline' });
                    statusRef.set({ state: 'online' });
                }
            });
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                myUid = user.uid;
                setOnlineStatus(myUid);
                loadInbox();
            } else { window.location.href = "login.html"; }
        });

        // ৩. সুন্দর সাউন্ড এবং প্যানেল নোটিফিকেশন
        function playNotificationSound() {
            // Messenger style clear sound
            const sound = new Audio('https://raw.githubusercontent.com/Luanfv/messenger-notification-sound/master/messenger_notification.mp3');
            sound.play().catch(e => console.log("User interaction required for sound"));
        }

        function triggerUINotification(title, body) {
            if (Notification.permission === "granted" && swReg) {
                swReg.showNotification(title, {
                    body: body,
                    icon: 'https://cdn-icons-png.flaticon.com/512/733/733547.png',
                    tag: 'msg-' + title // এক ইউজারের জন্য একটিই প্যানেল থাকবে
                });
                playNotificationSound();
            }
        }

        async function loadInbox() {
            const listContainer = document.getElementById('chat-list');
            
            db.ref('chats').on('value', async (snapshot) => {
                const chats = snapshot.val() || {};
                let inboxData = [];
                let newestMsgTime = 0;

                for (let chatId in chats) {
                    if (chatId.includes(myUid)) {
                        const targetUid = chatId.replace(myUid, "").replace("_", "");
                        const messages = Object.values(chats[chatId]);
                        const lastMsg = messages[messages.length - 1];

                        // নোটিফিকেশন ট্রিগার: যদি নতুন মেসেজ হয় এবং অন্যের পাঠানো হয়
                        if (lastMsg.senderId !== myUid && lastMsg.timestamp > lastTimestamp) {
                            const uSnap = await db.ref(`user-info/${targetUid}/profile`).once('value');
                            triggerUINotification(uSnap.val()?.fullName || "New Message", lastMsg.text);
                            if(lastMsg.timestamp > newestMsgTime) newestTime = lastMsg.timestamp;
                        }

                        // স্ট্যাটাস ও প্রোফাইল ডেটা লোড
                        const [pSnap, sSnap] = await Promise.all([
                            db.ref(`user-info/${targetUid}/profile`).once('value'),
                            db.ref(`status/${targetUid}`).once('value')
                        ]);

                        inboxData.push({
                            uid: targetUid,
                            name: pSnap.val()?.fullName || "Social User",
                            photo: pSnap.val()?.profilePic || `https://ui-avatars.com/api/?name=U`,
                            lastMsg: lastMsg.text,
                            timestamp: lastMsg.timestamp,
                            isOnline: sSnap.val()?.state === 'online'
                        });
                    }
                }
                
                if (newestMsgTime > lastTimestamp) lastTimestamp = newestMsgTime;
                
                inboxData.sort((a, b) => b.timestamp - a.timestamp);
                renderInbox(inboxData);
            });
        }

        function renderInbox(data) {
            const listContainer = document.getElementById('chat-list');
            if(data.length === 0) {
                listContainer.innerHTML = '<p class="text-center p-10 text-gray-400">No chats yet.</p>';
                return;
            }
            listContainer.innerHTML = data.map(item => `
                <div onclick="window.location.href='chat.html?uid=${item.uid}'" class="flex items-center gap-3 p-4 border-b chat-item cursor-pointer">
                    <div class="relative">
                        <img src="${item.photo}" class="w-14 h-14 rounded-full border object-cover">
                        <span class="${item.isOnline ? 'online-dot' : 'offline-dot'}"></span>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-900">${item.name}</h3>
                        <p class="text-sm text-gray-500 truncate w-60">${item.lastMsg}</p>
                    </div>
                </div>
            `).join('');
        }

        // ব্রাউজার সাউন্ড পারমিশন সিকিউরিটি ফিক্স
        document.onclick = () => {
            if (Notification.permission !== "granted") Notification.requestPermission();
        };
    </script>
    <script>// ১. Blue Badge SVG Constant (Script-er shuru-te add koro)
const blueBadge = `<svg class="inline-block w-[14px] h-[14px] ml-1 mb-0.5 text-[#1877F2]" viewBox="0 0 24 24" fill="currentColor"><path d="M9.707 19.121a.997.997 0 01-1.414 0l-5.646-5.647a1.5 1.5 0 010-2.121l.707-.707a1.5 1.5 0 012.121 0L9 14.167l8.528-8.527a1.5 1.5 0 012.122 0l.707.707a1.5 1.5 0 010 2.121l-9.944 9.944a1 1 0 01-.706.709z" /></svg>`;

// ২. Updated loadInbox Function (Verification check soho)
async function loadInbox() {
    const listContainer = document.getElementById('chat-list');
    
    db.ref('chats').on('value', async (snapshot) => {
        const chats = snapshot.val() || {};
        let inboxData = [];
        let newestMsgTime = 0;

        for (let chatId in chats) {
            if (chatId.includes(myUid)) {
                const targetUid = chatId.replace(myUid, "").replace("_", "");
                const messages = Object.values(chats[chatId]);
                const lastMsg = messages[messages.length - 1];

                // Profile and Verification status fetch
                const [pSnap, sSnap] = await Promise.all([
                    db.ref(`user-info/${targetUid}/profile`).once('value'),
                    db.ref(`status/${targetUid}`).once('value')
                ]);

                const profileData = pSnap.val() || {};

                inboxData.push({
                    uid: targetUid,
                    name: profileData.fullName || "Social User",
                    photo: profileData.profilePic || `https://ui-avatars.com/api/?name=U`,
                    lastMsg: lastMsg.text,
                    timestamp: lastMsg.timestamp,
                    isOnline: sSnap.val()?.state === 'online',
                    isVerified: profileData.isVerified || false // Verified status added
                });

                // Notification Logic (Ager motoi thakbe)
                if (lastMsg.senderId !== myUid && lastMsg.timestamp > lastTimestamp) {
                    triggerUINotification(profileData.fullName || "New Message", lastMsg.text);
                    if(lastMsg.timestamp > newestMsgTime) newestMsgTime = lastMsg.timestamp;
                }
            }
        }
        
        if (newestMsgTime > lastTimestamp) lastTimestamp = newestMsgTime;
        inboxData.sort((a, b) => b.timestamp - a.timestamp);
        renderInbox(inboxData);
    });
}

// ৩. Updated renderInbox Function
function renderInbox(data) {
    const listContainer = document.getElementById('chat-list');
    if(data.length === 0) {
        listContainer.innerHTML = '<p class="text-center p-10 text-gray-400">No chats yet.</p>';
        return;
    }
    listContainer.innerHTML = data.map(item => `
        <div onclick="window.location.href='chat.html?uid=${item.uid}'" class="flex items-center gap-3 p-4 border-b chat-item cursor-pointer">
            <div class="relative">
                <img src="${item.photo}" class="w-14 h-14 rounded-full border object-cover">
                <span class="${item.isOnline ? 'online-dot' : 'offline-dot'}"></span>
            </div>
            <div class="flex-1">
                <h3 class="font-bold text-gray-900">
                    ${item.name}${item.isVerified ? blueBadge : ""}
                </h3>
                <p class="text-sm text-gray-500 truncate w-60">${item.lastMsg}</p>
            </div>
        </div>
    `).join('');
}</script>
</body>
</html>