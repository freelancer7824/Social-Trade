<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inbox - SocialTrade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        body { background-color: #f7f8fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; margin: 0; }
        
        /* üîî Modern Push Notification Popup */
        #pushNotification { 
            position: fixed; top: -120px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; z-index: 9999; 
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        #pushNotification.show { top: 20px; }

        .notif-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 12px 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.05);
            display: flex; align-items: center; gap: 12px;
        }

        /* Iframe & UI */
        #chatView { display: none; position: fixed; inset: 0; z-index: 1000; background: white; flex-direction: column; }
        #chatIframe { flex-grow: 1; width: 100%; border: none; }
        .online-dot { width: 12px; height: 12px; background-color: #31a24c; border: 2px solid white; border-radius: 50%; position: absolute; bottom: 2px; right: 2px; }
    </style>
</head>
<body class="max-w-[500px] mx-auto h-screen shadow-2xl bg-white">

    <div id="pushNotification">
        <div id="notifBtn" class="notif-card cursor-pointer active:scale-95 transition-transform">
            <div class="relative">
                <img id="notifImg" src="" class="w-12 h-12 rounded-full object-cover border-2 border-blue-500">
                <div class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white animate-pulse"></div>
            </div>
            <div class="flex-1 overflow-hidden">
                <div class="flex justify-between items-center">
                    <span id="notifName" class="font-bold text-gray-800 truncate">User Name</span>
                    <span class="text-[9px] text-gray-400 font-bold uppercase tracking-wider">Just now</span>
                </div>
                <p id="notifMsg" class="text-sm text-gray-600 truncate mt-0.5">Sent a message...</p>
            </div>
        </div>
    </div>

    <div id="chatView">
        <div class="h-[60px] border-b flex items-center px-4 bg-white">
            <button onclick="closeChat()" class="text-blue-600 text-xl mr-3"><i class="fas fa-arrow-left"></i></button>
            <img id="headerPic" src="" class="w-10 h-10 rounded-full border">
            <div class="ml-3">
                <h2 id="chatTitle" class="font-bold text-gray-800 text-sm">Chat</h2>
                <p class="text-[11px] text-green-500 font-bold">Active now</p>
            </div>
        </div>
        <iframe id="chatIframe" src=""></iframe>
    </div>

    <div id="inboxContainer" class="flex flex-col h-full">
        <div class="p-5 flex justify-between items-center border-b bg-white">
            <h1 class="text-2xl font-black text-gray-800">Chats</h1>
            <button class="bg-gray-100 w-10 h-10 rounded-full flex items-center justify-center text-gray-600">
                <i class="fas fa-camera"></i>
            </button>
        </div>
        <div id="chat-list" class="flex-1 overflow-y-auto pb-20">
            <div class="p-10 text-center text-gray-400">Loading chats...</div>
        </div>
    </div>

    <script>
        // --- 1. Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA",
            authDomain: "social-media-5e6c8.firebaseapp.com",
            databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com/",
            projectId: "social-media-5e6c8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let myUid = "";
        let isChatOpen = false;

        // --- 2. Active Status Logic ---
        function setStatus(uid) {
            if (!uid) return;
            const statusRef = db.ref(`status/${uid}`);
            const connectedRef = db.ref('.info/connected');

            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    // ‡¶Ø‡¶ñ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡ßá‡¶ú ‡¶•‡ßá‡¶ï‡ßá ‡¶ö‡¶≤‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá (Disconnect)
                    statusRef.onDisconnect().set({ 
                        state: 'offline', 
                        last_changed: firebase.database.ServerValue.TIMESTAMP 
                    });

                    // ‡¶Ø‡¶ñ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶è‡¶á ‡¶™‡ßá‡¶ú ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá (Online)
                    statusRef.set({ 
                        state: 'online', 
                        last_changed: firebase.database.ServerValue.TIMESTAMP 
                    });
                }
            });
        }

        // --- 3. Authentication Observer ---
        auth.onAuthStateChanged(user => {
            if (user) {
                myUid = user.uid;
                setStatus(myUid); // ‡¶™‡ßá‡¶ú ‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá‡¶á ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                loadInbox();
                listenForMessages();
            } else { 
                window.location.href = "login.html"; 
            }
        });

        // Handle back button for mobile
        window.onpopstate = () => { if(isChatOpen) closeChat(false); };

        // --- 4. UI Actions ---
        function openChat(uid, name, photo) {
            isChatOpen = true;
            document.getElementById('inboxContainer').style.display = 'none';
            document.getElementById('chatTitle').innerText = name;
            document.getElementById('headerPic').src = photo || 'https://ui-avatars.com/api/?name='+name;
            document.getElementById('chatIframe').src = `chat.html?receiverId=${uid}`;
            document.getElementById('chatView').style.display = 'flex';
            history.pushState({chat:true}, "");
        }

        function closeChat(push = true) {
            isChatOpen = false;
            document.getElementById('chatView').style.display = 'none';
            document.getElementById('chatIframe').src = "";
            document.getElementById('inboxContainer').style.display = 'flex';
            if(push) history.back();
        }

        // --- 5. Message Notification Logic ---
        function listenForMessages() {
            db.ref('chats').on('child_added', snapshot => {
                const chatId = snapshot.key;
                if (chatId.includes(myUid)) {
                    db.ref(`chats/${chatId}`).limitToLast(1).on('child_added', async msgSnap => {
                        const msg = msgSnap.val();
                        if (msg.senderId !== myUid) {
                            if (Date.now() - msg.timestamp < 5000) {
                                triggerNotif(msg.senderId, msg.text);
                            }
                        }
                    });
                }
            });
        }

        async function triggerNotif(senderId, text) {
            if (isChatOpen) return;
            const pSnap = await db.ref(`user-info/${senderId}/profile`).once('value');
            const p = pSnap.val() || {};
            const name = p.fullName || "New Message";
            const photo = p.profilePic || 'https://ui-avatars.com/api/?name='+name;

            const notif = document.getElementById('pushNotification');
            document.getElementById('notifImg').src = photo;
            document.getElementById('notifName').innerText = name;
            document.getElementById('notifMsg').innerText = text;

            notif.classList.add('show');
            new Audio('https://raw.githubusercontent.com/Luanfv/messenger-notification-sound/master/messenger_notification.mp3').play().catch(()=>{});

            document.getElementById('notifBtn').onclick = () => {
                openChat(senderId, name, photo);
                notif.classList.remove('show');
            };
            setTimeout(() => { notif.classList.remove('show'); }, 5000);
        }

        // --- 6. Load and Render Inbox ---
        async function loadInbox() {
            db.ref('chats').on('value', async snap => {
                const chats = snap.val() || {};
                let listPromises = [];

                for(let key in chats) {
                    if(key.includes(myUid)) {
                        const otherUid = key.replace(myUid,"").replace("_","");
                        const msgs = Object.values(chats[key]);
                        const last = msgs[msgs.length - 1];
                        
                        listPromises.push((async () => {
                            const [pS, sS] = await Promise.all([
                                db.ref(`user-info/${otherUid}/profile`).once('value'),
                                db.ref(`status/${otherUid}`).once('value')
                            ]);
                            const p = pS.val() || {};
                            return { 
                                uid: otherUid, 
                                name: p.fullName || "User", 
                                photo: p.profilePic, 
                                msg: last.text, 
                                time: last.timestamp, 
                                online: sS.val()?.state === 'online' 
                            };
                        })());
                    }
                }
                const list = await Promise.all(listPromises);
                list.sort((a,b) => b.time - a.time);
                render(list);
            });
        }

        function render(data) {
            const container = document.getElementById('chat-list');
            if (data.length === 0) {
                container.innerHTML = `<div class="p-10 text-center text-gray-400">No chats found.</div>`;
                return;
            }
            container.innerHTML = data.map(i => `
                <div onclick="openChat('${i.uid}', '${i.name}', '${i.photo}')" class="flex items-center gap-4 p-4 border-b active:bg-gray-100 transition">
                    <div class="relative">
                        <img src="${i.photo || 'https://ui-avatars.com/api/?name='+i.name}" class="w-14 h-14 rounded-full object-cover">
                        <span class="${i.online ? 'online-dot' : ''}"></span>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-gray-800">${i.name}</h3>
                            <span class="text-[10px] text-gray-400">${new Date(i.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                        </div>
                        <p class="text-sm text-gray-500 truncate">${i.msg}</p>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>        </div>
        <div id="chat-list" class="flex-1 overflow-y-auto pb-20">
            <div class="p-10 text-center text-gray-400">Loading chats...</div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA",
            authDomain: "social-media-5e6c8.firebaseapp.com",
            databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com/",
            projectId: "social-media-5e6c8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let myUid = "";
        let isChatOpen = false;
        let isFirstLoad = true; // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶¨‡¶æ‡¶∞ ‡¶∏‡¶¨ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡ßü‡¶æ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶¨‡¶®‡ßç‡¶ß ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá

        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶è‡¶ï‡¶ü‡¶ø‡¶≠ ‡¶ï‡¶∞‡¶æ
        function setStatus(uid) {
            const statusRef = db.ref(`status/${uid}`);
            db.ref('.info/connected').on('value', snap => {
                if(snap.val()) {
                    statusRef.onDisconnect().set({ state: 'offline' });
                    statusRef.set({ state: 'online' });
                }
            });
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                myUid = user.uid;
                setStatus(myUid);
                loadInbox();
                listenForMessages();
            } else { window.location.href = "login.html"; }
        });

        // ‡¶´‡ßã‡¶®‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï ‡¶¨‡¶æ‡¶ü‡¶® ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤ ‡¶ï‡¶∞‡¶æ
        window.onpopstate = () => { if(isChatOpen) closeChat(false); };

        function openChat(uid, name, photo) {
            isChatOpen = true;
            document.getElementById('inboxContainer').style.display = 'none';
            document.getElementById('chatTitle').innerText = name;
            document.getElementById('headerPic').src = photo || 'https://ui-avatars.com/api/?name='+name;
            document.getElementById('chatIframe').src = `chat.html?receiverId=${uid}`;
            document.getElementById('chatView').style.display = 'flex';
            history.pushState({chat:true}, "");
        }

        function closeChat(push = true) {
            isChatOpen = false;
            document.getElementById('chatView').style.display = 'none';
            document.getElementById('chatIframe').src = "";
            document.getElementById('inboxContainer').style.display = 'flex';
            if(push) history.back();
        }

        // üîî ‡¶∞‡¶ø‡ßü‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ (‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
        function listenForMessages() {
            // ‡¶∏‡¶ï‡¶≤ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶®‡ßã‡¶° ‡¶≤‡¶ø‡¶∏‡ßá‡¶® ‡¶ï‡¶∞‡¶æ
            db.ref('chats').on('child_added', snapshot => {
                const chatId = snapshot.key;
                if (chatId.includes(myUid)) {
                    // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶∏‡¶æ ‡ßß‡¶ü‡¶ø ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶∏‡ßá‡¶® ‡¶ï‡¶∞‡¶æ
                    db.ref(`chats/${chatId}`).limitToLast(1).on('child_added', async msgSnap => {
                        const msg = msgSnap.val();
                        
                        // ‡¶Ø‡¶¶‡¶ø ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶æ ‡¶π‡ßü ‡¶è‡¶¨‡¶Ç ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶™‡¶∞‡ßá‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶π‡ßü
                        if (msg.senderId !== myUid) {
                            // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶ï‡ßü‡ßá‡¶ï ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶¶‡¶ø‡¶¨‡ßá
                            if (Date.now() - msg.timestamp < 5000) {
                                triggerNotif(msg.senderId, msg.text);
                            }
                        }
                    });
                }
            });
        }

        async function triggerNotif(senderId, text) {
            if (isChatOpen) return; // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ì‡¶™‡ßá‡¶® ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶Ü‡¶∏‡¶¨‡ßá ‡¶®‡¶æ

            const pSnap = await db.ref(`user-info/${senderId}/profile`).once('value');
            const p = pSnap.val() || {};
            const name = p.fullName || "New Message";
            const photo = p.profilePic || 'https://ui-avatars.com/api/?name='+name;

            const notif = document.getElementById('pushNotification');
            document.getElementById('notifImg').src = photo;
            document.getElementById('notifName').innerText = name;
            document.getElementById('notifMsg').innerText = text;

            // ‡¶™‡¶™‡¶Ü‡¶™ ‡¶∂‡ßã ‡¶ï‡¶∞‡¶æ
            notif.classList.add('show');
            new Audio('https://raw.githubusercontent.com/Luanfv/messenger-notification-sound/master/messenger_notification.mp3').play().catch(()=>{});

            document.getElementById('notifBtn').onclick = () => {
                openChat(senderId, name, photo);
                notif.classList.remove('show');
            };

            setTimeout(() => { notif.classList.remove('show'); }, 5000);
        }

        async function loadInbox() {
            db.ref('chats').on('value', async snap => {
                const chats = snap.val() || {};
                let list = [];
                for(let key in chats) {
                    if(key.includes(myUid)) {
                        const otherUid = key.replace(myUid,"").replace("_","");
                        const msgs = Object.values(chats[key]);
                        const last = msgs[msgs.length - 1];
                        
                        const [pS, sS] = await Promise.all([
                            db.ref(`user-info/${otherUid}/profile`).once('value'),
                            db.ref(`status/${otherUid}`).once('value')
                        ]);

                        const p = pS.val() || {};
                        list.push({ uid: otherUid, name: p.fullName, photo: p.profilePic, msg: last.text, time: last.timestamp, online: sS.val()?.state === 'online' });
                    }
                }
                list.sort((a,b) => b.time - a.time);
                render(list);
            });
        }

        function render(data) {
            const container = document.getElementById('chat-list');
            container.innerHTML = data.map(i => `
                <div onclick="openChat('${i.uid}', '${i.name}', '${i.photo}')" class="flex items-center gap-4 p-4 border-b active:bg-gray-100 transition">
                    <div class="relative">
                        <img src="${i.photo || 'https://ui-avatars.com/api/?name='+i.name}" class="w-14 h-14 rounded-full object-cover">
                        <span class="${i.online ? 'online-dot' : ''}"></span>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-gray-800">${i.name}</h3>
                            <span class="text-[10px] text-gray-400">${new Date(i.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                        </div>
                        <p class="text-sm text-gray-500 truncate">${i.msg}</p>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>            apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA",
            authDomain: "social-media-5e6c8.firebaseapp.com",
            databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com/",
            projectId: "social-media-5e6c8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let myUid = "";
        let isChatOpen = false;
        let lastHandledMsgTime = Date.now();

        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶è‡¶ï‡¶ü‡¶ø‡¶≠ ‡¶∞‡¶æ‡¶ñ‡¶æ
        function setOnlineStatus(uid) {
            const statusRef = db.ref(`status/${uid}`);
            db.ref('.info/connected').on('value', snap => {
                if (snap.val()) {
                    statusRef.onDisconnect().set({ state: 'offline', last_seen: firebase.database.ServerValue.TIMESTAMP });
                    statusRef.set({ state: 'online', last_seen: firebase.database.ServerValue.TIMESTAMP });
                }
            });
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                myUid = user.uid;
                setOnlineStatus(myUid);
                loadInbox();
                startNotificationListener();
            } else { window.location.href = "login.html"; }
        });

        // ‡¶´‡ßã‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï ‡¶¨‡¶æ‡¶ü‡¶® ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤‡¶ø‡¶Ç
        window.onpopstate = function() {
            if (isChatOpen) closeChat(false);
        };

        function openChat(uid, name, photo, isOnline) {
            isChatOpen = true;
            document.getElementById('inboxContainer').style.display = 'none';
            document.getElementById('chatTitle').innerText = name;
            document.getElementById('headerPic').src = photo || 'https://ui-avatars.com/api/?name=' + name;
            document.getElementById('chatStatusText').innerText = isOnline ? "Active now" : "Offline";
            document.getElementById('chatIframe').src = `chat.html?receiverId=${uid}`;
            document.getElementById('chatView').style.display = 'flex';
            
            history.pushState({chatOpen: true}, "");
        }

        function closeChat(pushHistory = true) {
            isChatOpen = false;
            document.getElementById('chatView').style.display = 'none';
            document.getElementById('chatIframe').src = "";
            document.getElementById('inboxContainer').style.display = 'flex';
            if (pushHistory) history.back();
        }

        // ‡¶™‡ßÅ‡¶∂ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶∂‡ßã ‡¶ï‡¶∞‡¶æ
        function showPushNotif(uid, name, photo, text) {
            if (isChatOpen) return; // ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ì‡¶™‡ßá‡¶® ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá ‡¶®‡¶æ
            
            const popup = document.getElementById('pushNotification');
            document.getElementById('notifSenderPhoto').src = photo || 'https://ui-avatars.com/api/?name=' + name;
            document.getElementById('notifSenderName').innerText = name;
            document.getElementById('notifText').innerText = text;

            popup.style.top = '20px';
            
            document.getElementById('notifClick').onclick = () => {
                openChat(uid, name, photo, true);
                popup.style.top = '-100px';
            };

            setTimeout(() => { popup.style.top = '-100px'; }, 4000);
            
            // Notification Sound
            new Audio('https://raw.githubusercontent.com/Luanfv/messenger-notification-sound/master/messenger_notification.mp3').play().catch(() => {});
        }

        function startNotificationListener() {
            db.ref('chats').on('value', async snapshot => {
                const chats = snapshot.val();
                if (!chats) return;

                for (let key in chats) {
                    if (key.includes(myUid)) {
                        const msgs = Object.values(chats[key]);
                        const lastMsg = msgs[msgs.length - 1];

                        if (lastMsg.senderId !== myUid && lastMsg.timestamp > lastHandledMsgTime) {
                            lastHandledMsgTime = lastMsg.timestamp;
                            const pSnap = await db.ref(`user-info/${lastMsg.senderId}/profile`).once('value');
                            const p = pSnap.val() || {};
                            showPushNotif(lastMsg.senderId, p.fullName, p.profilePic, lastMsg.text);
                        }
                    }
                }
            });
        }

        async function loadInbox() {
            db.ref('chats').on('value', async snapshot => {
                const chats = snapshot.val() || {};
                let listData = [];

                for (let key in chats) {
                    if (key.includes(myUid)) {
                        const otherId = key.replace(myUid, "").replace("_", "");
                        const msgs = Object.values(chats[key]);
                        const last = msgs[msgs.length - 1];

                        const [pSnap, sSnap] = await Promise.all([
                            db.ref(`user-info/${otherId}/profile`).once('value'),
                            db.ref(`status/${otherId}`).once('value')
                        ]);

                        const p = pSnap.val() || {};
                        listData.push({
                            uid: otherId,
                            name: p.fullName || "User",
                            photo: p.profilePic,
                            text: last.text,
                            ts: last.timestamp,
                            online: sSnap.val()?.state === 'online'
                        });
                    }
                }
                listData.sort((a, b) => b.ts - a.ts);
                renderInbox(listData);
            });
        }

        function renderInbox(data) {
            const container = document.getElementById('chat-list');
            if (!data.length) {
                container.innerHTML = '<p class="text-center p-10 text-gray-400">No chats yet.</p>';
                return;
            }
            container.innerHTML = data.map(i => `
                <div onclick="openChat('${i.uid}', '${i.name}', '${i.photo}', ${i.online})" class="flex items-center gap-3 p-4 border-b active:bg-gray-100 cursor-pointer transition">
                    <div class="relative">
                        <img src="${i.photo || 'https://ui-avatars.com/api/?name='+i.name}" class="w-14 h-14 rounded-full border object-cover">
                        <span class="${i.online ? 'online-dot' : 'offline-dot'}"></span>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <div class="flex justify-between items-center mb-0.5">
                            <h3 class="font-bold text-[15px]">${i.name}</h3>
                            <span class="text-[10px] text-gray-400">${new Date(i.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                        </div>
                        <p class="text-sm text-gray-500 truncate">${i.text}</p>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
