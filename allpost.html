<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialTrade - Pro Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Helvetica, Arial, sans-serif; overflow-anchor: none; }
        .post-card { background: white; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .colored-content { min-height: 300px; display: flex; align-items: center; justify-content: center; padding: 30px; text-align: center; font-size: 1.8rem; font-weight: 800; color: white; border-radius: 4px; }
        .comment-bubble { background: #f0f2f5; border-radius: 18px; padding: 8px 12px; max-width: 85%; }
        .action-btn { flex: 1; padding: 8px 0; font-size: 14px; font-weight: 600; color: #65676b; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .action-btn:hover { background: #f2f2f2; border-radius: 4px; }
        .active-like { color: #1877F2 !important; }
        .status-dot { width: 12px; height: 12px; border: 2px solid white; border-radius: 50%; position: absolute; bottom: 2px; right: 2px; }
        .online { background-color: #31a24c; }
        .offline { background-color: #90949c; }

        /* Follow Button Style */
        .follow-btn { font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 6px; margin-left: 10px; cursor: pointer; }
        .btn-follow { color: #1877F2; border: 1px solid #1877F2; }
        .btn-following { color: #65676b; background: #e4e6eb; }

        /* Iframe Modal Overlay */
        #profileOverlay { display: none; position: fixed; inset: 0; z-index: 1000; background: white; }
        #profileIframe { width: 100%; height: calc(100% - 50px); border: none; }
    </style>
</head>
<body class="pb-10">

    <div id="profileOverlay">
        <div class="h-[50px] border-b flex items-center px-4 bg-white shadow-sm">
            <button onclick="closeProfile()" class="text-[#1877F2] font-bold flex items-center gap-2">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <span id="overlayTitle" class="ml-4 font-bold text-gray-700">Profile</span>
        </div>
        <iframe id="profileIframe" src=""></iframe>
    </div>

    <div class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-[500px] mx-auto p-3 flex items-center gap-3">
            <h1 class="text-2xl font-bold text-[#1877F2] cursor-pointer" onclick="location.reload()">
                <i class="fas fa-home"></i>
            </h1>
            
            <div class="relative flex-1">
                <input type="text" id="searchInput" placeholder="Search friends..." 
                    class="w-full bg-gray-100 rounded-full py-1.5 px-10 text-[14px] outline-none border border-transparent focus:border-blue-300">
                <i class="fas fa-search absolute left-4 top-2.5 text-gray-400 text-sm"></i>
            </div>

            <div class="flex gap-4 items-center text-gray-600">
                <a href="sms-list.html"><i class="fab fa-facebook-messenger text-xl text-[#0084FF]"></i></a>
                <a href="javascript:void(0)" onclick="openProfile(auth.currentUser.uid, 'My Profile')">
                    <i class="fas fa-user-circle text-2xl"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="max-w-[500px] mx-auto p-2" id="postsContainer">
        <div class="text-center py-20 text-gray-400"><i class="fas fa-spinner fa-spin text-3xl"></i></div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA",
        authDomain: "social-media-5e6c8.firebaseapp.com",
        databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com/",
        projectId: "social-media-5e6c8",
        storageBucket: "social-media-5e6c8.firebasestorage.app",
        messagingSenderId: "897473713729",
        appId: "1:897473713729:web:7ba552ed4c1be8754418c0"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const blueBadge = `<svg class="inline-block w-[14px] h-[14px] ml-1 mb-0.5 text-[#1877F2]" viewBox="0 0 24 24" fill="currentColor"><path d="M9.707 19.121a.997.997 0 01-1.414 0l-5.646-5.647a1.5 1.5 0 010-2.121l.707-.707a1.5 1.5 0 012.121 0L9 14.167l8.528-8.527a1.5 1.5 0 012.122 0l.707.707a1.5 1.5 0 010 2.121l-9.944 9.944a1 1 0 01-.706.709z" /></svg>`;

    let allPostsData = [];
    let userCache = {};
    let myFollowing = {};
    let openCommentSections = {};

    function timeAgo(ts) {
        const s = Math.floor((new Date() - ts) / 1000);
        if (s < 60) return "Just now";
        if (s < 3600) return Math.floor(s/60) + "m";
        if (s < 86400) return Math.floor(s/3600) + "h";
        return Math.floor(s/86400) + "d";
    }

    // --- Iframe System ---
    function openProfile(uid, name) {
        document.getElementById('overlayTitle').innerText = name;
        document.getElementById('profileIframe').src = `profile.html?uid=${uid}`;
        document.getElementById('profileOverlay').style.display = 'block';
        document.body.style.overflow = "hidden";
        history.pushState({view: 'profile'}, "");
    }

    function closeProfile() {
        document.getElementById('profileOverlay').style.display = 'none';
        document.getElementById('profileIframe').src = "";
        document.body.style.overflow = "auto";
    }

    window.onpopstate = () => closeProfile();

    // --- Follow Logic ---
    async function handleFollow(targetUid, event) {
        event.stopPropagation();
        const myUid = auth.currentUser.uid;
        const isFollowing = myFollowing[targetUid];
        if(isFollowing) {
            await db.ref(`user-following/${myUid}/${targetUid}`).remove();
            await db.ref(`user-followers/${targetUid}/${myUid}`).remove();
        } else {
            await db.ref(`user-following/${myUid}/${targetUid}`).set(true);
            await db.ref(`user-followers/${targetUid}/${myUid}`).set(true);
        }
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            db.ref(`status/${user.uid}`).set({ state: 'online', last: Date.now() });
            db.ref(`status/${user.uid}`).onDisconnect().set({ state: 'offline', last: Date.now() });
            
            db.ref(`user-following/${user.uid}`).on('value', snap => {
                myFollowing = snap.val() || {};
                renderFeed(); 
            });

            loadData();
        } else { window.location.href = "login.html"; }
    });

    function loadData() {
        db.ref('user-info').on('value', uSnap => {
            userCache = {};
            uSnap.forEach(u => { userCache[u.key] = u.val().profile; });
            
            db.ref('posts').on('value', pSnap => {
                allPostsData = [];
                pSnap.forEach(post => {
                    const d = post.val();
                    const p = userCache[d.uid] || { fullName: "User" };
                    allPostsData.push({ id: post.key, ...d, fullName: p.fullName, profilePic: p.profilePic, isVerified: p.isVerified });
                });
                allPostsData.sort((a,b) => b.timestamp - a.timestamp);
                renderFeed();
            });
        });
    }

    function renderFeed() {
        const container = document.getElementById('postsContainer');
        const search = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allPostsData.filter(p => p.fullName.toLowerCase().includes(search));

        container.innerHTML = filtered.map(post => {
            const isLiked = post.likedBy && post.likedBy[auth.currentUser.uid];
            const hasBg = post.background && post.background !== "none";
            const isBoxOpen = openCommentSections[post.id] ? '' : 'hidden';

            let followHtml = "";
            if(post.isVerified && post.uid !== auth.currentUser.uid) {
                const isFollowing = myFollowing[post.uid];
                followHtml = `<button onclick="handleFollow('${post.uid}', event)" class="follow-btn ${isFollowing ? 'btn-following' : 'btn-follow'}">${isFollowing ? 'Following' : 'Follow'}</button>`;
            }

            return `
            <div class="post-card">
                <div class="p-3 flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="relative cursor-pointer" onclick="openProfile('${post.uid}', '${post.fullName}')">
                            <img src="${post.profilePic || 'https://ui-avatars.com/api/?name='+post.fullName}" class="h-10 w-10 rounded-full border">
                            <div id="stat-${post.id}" class="status-dot offline"></div>
                        </div>
                        <div class="ml-2">
                            <div class="flex items-center">
                                <p class="text-[15px] font-bold cursor-pointer" onclick="openProfile('${post.uid}', '${post.fullName}')">${post.fullName}${post.isVerified ? blueBadge : ""}</p>
                                ${followHtml}
                            </div>
                            <p class="text-[#65676b] text-[12px]">${timeAgo(post.timestamp)} ago</p>
                        </div>
                    </div>
                </div>

                <div class="${hasBg ? 'colored-content' : 'px-4 pb-2 text-[16px]'}" style="background: ${hasBg ? post.background : 'transparent'}">
                    ${post.text}
                </div>

                <div class="px-4 py-2 flex justify-between text-[#65676b] text-[13px] border-b mx-3">
                    <span><i class="fas fa-thumbs-up text-blue-500"></i> ${post.likedBy ? Object.keys(post.likedBy).length : 0}</span>
                    <span class="cursor-pointer" onclick="toggleComments('${post.id}')">${post.comments ? Object.keys(post.comments).length : 0} comments</span>
                </div>

                <div class="px-2 py-1 flex">
                    <button onclick="handleLike('${post.id}')" class="action-btn ${isLiked ? 'active-like' : ''}"><i class="${isLiked ? 'fas' : 'far'} fa-thumbs-up"></i> Like</button>
                    <button onclick="toggleComments('${post.id}')" class="action-btn"><i class="far fa-comment"></i> Comment</button>
                </div>

                <div id="sec-${post.id}" class="${isBoxOpen} border-t bg-gray-50/50">
                    <div class="p-3 space-y-3 max-h-80 overflow-y-auto">${renderComments(post.comments)}</div>
                    <div class="p-3 flex gap-2 bg-white border-t">
                        <input type="text" id="in-${post.id}" placeholder="Write a comment..." class="bg-gray-100 flex-1 rounded-full px-4 py-2 text-sm outline-none" onkeypress="if(event.key === 'Enter') postComment('${post.id}')">
                        <button onclick="postComment('${post.id}')" class="text-[#1877F2] px-2"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>`;
        }).join('');
        filtered.forEach(p => listenStatus(p.uid, `stat-${p.id}`));
    }

    function renderComments(comments) {
        if (!comments) return `<p class="text-center text-xs text-gray-400 py-2">No comments yet.</p>`;
        return Object.values(comments).sort((a,b)=>b.timestamp-a.timestamp).map(c => {
            const p = userCache[c.uid] || { isVerified: false };
            return `
            <div class="flex gap-2">
                <img src="${c.userPhoto || 'https://ui-avatars.com/api/?name='+c.userName}" class="h-8 w-8 rounded-full cursor-pointer" onclick="openProfile('${c.uid}', '${c.userName}')">
                <div class="comment-bubble">
                    <p class="text-[12px] font-bold cursor-pointer" onclick="openProfile('${c.uid}', '${c.userName}')">${c.userName}${p.isVerified ? blueBadge : ""} <span class="font-normal text-gray-400">â€¢ ${timeAgo(c.timestamp)}</span></p>
                    <p class="text-[13px] text-gray-800">${c.text}</p>
                </div>
            </div>`;
        }).join('');
    }

    function listenStatus(uid, dotId) {
        db.ref(`status/${uid}`).on('value', snap => {
            const dot = document.getElementById(dotId);
            if (dot) dot.className = `status-dot ${snap.val() && snap.val().state === 'online' ? 'online' : 'offline'}`;
        });
    }

    async function handleLike(pid) {
        const ref = db.ref(`posts/${pid}/likedBy/${auth.currentUser.uid}`);
        const snap = await ref.get();
        snap.exists() ? await ref.remove() : await ref.set(true);
    }

    async function postComment(pid) {
        const input = document.getElementById(`in-${pid}`);
        const text = input.value.trim();
        if (!text) return;
        openCommentSections[pid] = true;
        const myProfile = userCache[auth.currentUser.uid] || {};
        await db.ref(`posts/${pid}/comments`).push({
            uid: auth.currentUser.uid, userName: myProfile.fullName || "User",
            userPhoto: myProfile.profilePic || "", text: text, timestamp: Date.now()
        });
        input.value = "";
    }

    function toggleComments(pid) {
        const el = document.getElementById(`sec-${pid}`);
        el.classList.toggle('hidden');
        openCommentSections[pid] = !el.classList.contains('hidden');
    }

    document.getElementById('searchInput').addEventListener('input', () => renderFeed());
</script>
</body>
</html>
