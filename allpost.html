<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialTrade Pro - Smart Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Arial, sans-serif; overflow-anchor: none; }
        .post-card { background: white; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border: 1px solid #e4e6eb; }
        .colored-content { min-height: 250px; display: flex; align-items: center; justify-content: center; padding: 25px; text-align: center; font-size: 1.6rem; font-weight: 800; color: white; border-radius: 8px; }
        .text-limit { display: -webkit-box; -webkit-line-clamp: 6; -webkit-box-orient: vertical; overflow: hidden; }
        .comment-container { padding: 8px 12px; display: flex; flex-direction: column; gap: 8px; max-height: 280px; overflow-y: auto; }
        .comment-bubble { background: #f0f2f5; border-radius: 18px; padding: 8px 12px; }
        .action-btn { flex: 1; padding: 8px 0; font-size: 14px; font-weight: 600; color: #65676b; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .active-like { color: #1877F2 !important; }
        .status-dot { width: 11px; height: 11px; border: 2px solid white; border-radius: 50%; position: absolute; bottom: 2px; right: 2px; }
        .online { background-color: #31a24c; }
        .offline { background-color: #90949c; }
    </style>
</head>
<body class="pb-10">

    <div class="bg-white shadow-sm sticky top-0 z-50 mb-2">
        <div class="max-w-[500px] mx-auto p-3 flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-[#1877F2] cursor-pointer" onclick="location.reload()">
                    <i class="fas fa-home"></i>
                </h1>
                <div class="flex gap-4 items-center text-gray-600">
                    <a href="sms-list.html"><i class="fab fa-facebook-messenger text-xl text-[#0084FF]"></i></a>
                    <a href="profile.html"><i class="fas fa-user-circle text-xl"></i></a>
                </div>
            </div>
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Search friends by name..." 
                    class="w-full bg-gray-100 rounded-full py-2 px-10 outline-none focus:ring-1 focus:ring-blue-400">
                <i class="fas fa-search absolute left-4 top-3 text-gray-400"></i>
            </div>
        </div>
    </div>

    <div class="max-w-[500px] mx-auto p-2" id="postsContainer">
        <div class="text-center py-20 text-gray-400"><i class="fas fa-spinner fa-spin text-2xl"></i></div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA",
        authDomain: "social-media-5e6c8.firebaseapp.com",
        databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com/",
        projectId: "social-media-5e6c8",
        storageBucket: "social-media-5e6c8.firebasestorage.app",
        messagingSenderId: "897473713729",
        appId: "1:897473713729:web:7ba552ed4c1be8754418c0"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    
    let allPostsData = [];
    let userCache = {};
    let currentUserData = null;
    let openCommentSections = {}; 

    // Helper: Shuffle Array
    function shuffle(array) {
        return array.sort(() => Math.random() - 0.5);
    }

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            db.ref(`user-info/${user.uid}/profile`).on('value', snap => currentUserData = snap.val());
            loadAllData();
        } else { window.location.href = "login.html"; }
    });

    function loadAllData() {
        // First get all user profiles for instant name loading
        db.ref('user-info').on('value', userSnap => {
            userSnap.forEach(u => {
                userCache[u.key] = u.val().profile;
            });
            startFeedListener();
        });
    }

    function startFeedListener() {
        db.ref('posts').on('value', snapshot => {
            let tempPosts = [];
            snapshot.forEach(child => { 
                const data = child.val();
                const profile = userCache[data.uid] || { fullName: "User", profilePic: "" };
                tempPosts.push({ id: child.key, ...data, fullName: profile.fullName, profilePic: profile.profilePic }); 
            });

            // LOGIC: New posts priority + Random Shuffle for others
            // Sort by time first
            tempPosts.sort((a, b) => b.timestamp - a.timestamp);
            
            let newest = tempPosts.slice(0, 5); // Sobcheye notun 5 ta post shob somoy upore
            let others = tempPosts.slice(5);    // Baki shob post
            
            // Randomly shuffle 'others' jate prottek user alada order dekhe
            others = shuffle(others);
            
            allPostsData = [...newest, ...others];
            renderFeed(allPostsData);
        });
    }

    function renderFeed(posts) {
        const container = document.getElementById('postsContainer');
        container.innerHTML = posts.map(post => {
            const isLiked = post.likedBy && post.likedBy[auth.currentUser.uid];
            const hasBg = post.background && post.background !== "none";
            const likeCount = post.likedBy ? Object.keys(post.likedBy).length : 0;
            const commentCount = post.comments ? Object.keys(post.comments).length : 0;
            const isLong = post.text.length > 300;
            const isBoxOpen = openCommentSections[post.id] ? '' : 'hidden';

            return `
            <div class="post-card" id="card-${post.id}">
                <div class="p-3 flex items-center">
                    <div class="relative cursor-pointer" onclick="goToProfile('${post.uid}')">
                        <img src="${post.profilePic || 'https://ui-avatars.com/api/?name='+post.fullName}" class="h-10 w-10 rounded-full border">
                        <div id="stat-${post.id}" class="status-dot offline"></div>
                    </div>
                    <div class="ml-2">
                        <p class="text-[15px] font-bold text-[#050505] hover:underline cursor-pointer" onclick="goToProfile('${post.uid}')">${post.fullName}</p>
                        <p class="text-[#65676b] text-[12px]">${new Date(post.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                    </div>
                </div>

                <div id="ptext-${post.id}" class="${hasBg ? 'colored-content' : 'px-4 pb-1 text-[15px] ' + (isLong ? 'text-limit' : '')}" style="background: ${hasBg ? post.background : 'transparent'}">
                    ${escape(post.text)}
                </div>
                ${isLong && !hasBg ? `<button class="px-4 text-blue-600 font-bold text-sm mb-2" onclick="toggleText('${post.id}', this)">See more</button>` : ''}

                <div class="px-4 py-2 flex justify-between items-center text-[#65676b] text-[13px] border-b mx-3">
                    <span class="flex items-center"><img src="https://cdn-icons-png.flaticon.com/512/2107/2107845.png" class="w-4 h-4 mr-1"> ${likeCount}</span>
                    <span class="cursor-pointer font-medium" onclick="toggleComments('${post.id}')">${commentCount} comments</span>
                </div>

                <div class="px-2 py-1 flex">
                    <button onclick="handleLike('${post.id}')" class="action-btn ${isLiked ? 'active-like' : ''}">
                        <i class="${isLiked ? 'fas' : 'far'} fa-thumbs-up text-lg"></i> Like
                    </button>
                    <button onclick="toggleComments('${post.id}')" class="action-btn">
                        <i class="far fa-comment text-lg"></i> Comment
                    </button>
                </div>

                <div id="sec-${post.id}" class="${isBoxOpen} border-t bg-gray-50/50">
                    <div class="comment-container" id="list-${post.id}">${renderComments(post.comments)}</div>
                    <div class="p-3 flex gap-2 bg-white border-t">
                        <input type="text" id="in-${post.id}" placeholder="Write a comment..." class="bg-gray-100 flex-1 outline-none text-sm rounded-full px-4 py-2" onkeypress="if(event.key === 'Enter') postComment('${post.id}')">
                        <button onclick="postComment('${post.id}')" class="text-[#1877F2]"><i class="fas fa-paper-plane text-lg"></i></button>
                    </div>
                </div>
            </div>`;
        }).join('');
        
        posts.forEach(p => listenStatus(p.uid, `stat-${p.id}`));
    }

    // Navigation Logic: Profile visit without full reload
    function goToProfile(uid) {
        // Save scroll position before going
        sessionStorage.setItem('scrollPos', window.scrollY);
        window.location.href = `profile.html?uid=${uid}`;
    }

    // Restore scroll after returning
    window.onload = function() {
        const scrollPos = sessionStorage.getItem('scrollPos');
        if (scrollPos) {
            window.scrollTo(0, parseInt(scrollPos));
            sessionStorage.removeItem('scrollPos');
        }
    };

    function listenStatus(uid, dotId) {
        db.ref(`status/${uid}`).on('value', snap => {
            const dot = document.getElementById(dotId);
            if (dot) dot.className = `status-dot ${snap.val() === 'online' ? 'online' : 'offline'}`;
        });
    }

    document.getElementById('searchInput').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const filtered = allPostsData.filter(p => p.fullName.toLowerCase().includes(query));
        renderFeed(filtered);
    });

    async function handleLike(pid) {
        const ref = db.ref(`posts/${pid}/likedBy/${auth.currentUser.uid}`);
        const snap = await ref.get();
        snap.exists() ? await ref.remove() : await ref.set(true);
    }

    async function postComment(pid) {
        const input = document.getElementById(`in-${pid}`);
        const text = input.value.trim();
        if (!text || !currentUserData) return;
        openCommentSections[pid] = true;
        await db.ref(`posts/${pid}/comments`).push({
            uid: auth.currentUser.uid,
            userName: currentUserData.fullName,
            userPhoto: currentUserData.profilePic || "",
            text: text,
            timestamp: Date.now()
        });
        input.value = "";
    }

    function renderComments(comments) {
        if (!comments) return `<p class="text-center text-xs text-gray-400 py-4">No comments yet.</p>`;
        const list = Object.values(comments).sort((a, b) => b.timestamp - a.timestamp);
        return list.map(c => `
            <div class="flex gap-2">
                <img src="${c.userPhoto || 'https://ui-avatars.com/api/?name='+c.userName}" class="h-8 w-8 rounded-full cursor-pointer" onclick="goToProfile('${c.uid}')">
                <div class="comment-bubble">
                    <p class="text-[12px] font-bold hover:underline cursor-pointer" onclick="goToProfile('${c.uid}')">${escape(c.userName)}</p>
                    <p class="text-[13px] text-gray-800">${escape(c.text)}</p>
                </div>
            </div>`).join('');
    }

    function toggleComments(pid) {
        const sec = document.getElementById(`sec-${pid}`);
        if (sec.classList.contains('hidden')) {
            sec.classList.remove('hidden');
            openCommentSections[pid] = true;
        } else {
            sec.classList.add('hidden');
            delete openCommentSections[pid];
        }
    }

    function toggleText(pid, btn) {
        const el = document.getElementById(`ptext-${pid}`);
        el.classList.toggle('text-limit');
        btn.innerText = el.classList.contains('text-limit') ? "See more" : "See less";
    }

    function escape(str) {
        let div = document.createElement('div');
        div.innerText = str || "";
        return div.innerHTML;
    }
</script>
<script>
    // ... (Firebase config and init same thakbe)

    function startFeedListener() {
        db.ref('posts').on('value', snapshot => {
            let tempPosts = [];
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000; // 24 Ghonta millisecond-e

            snapshot.forEach(child => { 
                const data = child.val();
                const profile = userCache[data.uid] || { fullName: "User", profilePic: "" };
                tempPosts.push({ 
                    id: child.key, 
                    ...data, 
                    fullName: profile.fullName, 
                    profilePic: profile.profilePic 
                }); 
            });

            // 1. Post-guloke duiti vage vag kora (New vs Old)
            let newPosts = tempPosts.filter(p => (now - p.timestamp) < oneDay);
            let oldPosts = tempPosts.filter(p => (now - p.timestamp) >= oneDay);

            // 2. Notun post-gulo keo random shuffle koro jate ek-i post bar bar 1 number-e na thake
            newPosts = shuffle(newPosts);
            
            // 3. Purono post-gulo keo alomelo (random) koro
            oldPosts = shuffle(oldPosts);

            // 4. Final list: Age random notun post, tarpor random purono post
            allPostsData = [...newPosts, ...oldPosts];
            
            renderFeed(allPostsData);
        });
    }

    // Improved Shuffle Algorithm (Fisher-Yates) jate randomization aro valo hoy
    function shuffle(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [
            array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    // ... (renderFeed ebong baki function-gulo apnar code theke same thakbe)
</script>
<script>// 1. Blue Badge SVG Icon Constant (Eti script er ekdom upore ekbar rakhbe)
const blueBadge = `<svg class="inline-block w-[14px] h-[14px] ml-1 mb-0.5 text-[#1877F2]" viewBox="0 0 24 24" fill="currentColor"><path d="M9.707 19.121a.997.997 0 01-1.414 0l-5.646-5.647a1.5 1.5 0 010-2.121l.707-.707a1.5 1.5 0 012.121 0L9 14.167l8.528-8.527a1.5 1.5 0 012.122 0l.707.707a1.5 1.5 0 010 2.121l-9.944 9.944a1 1 0 01-.706.709z" /></svg>`;

// 2. Updated Feed Listener
function startFeedListener() {
    db.ref('posts').on('value', snapshot => {
        let tempPosts = [];
        const now = Date.now();
        const oneDay = 24 * 60 * 60 * 1000;

        snapshot.forEach(child => { 
            const data = child.val();
            // UserCache theke verification status check
            const profile = userCache[data.uid] || { fullName: "User", profilePic: "", isVerified: false };
            tempPosts.push({ 
                id: child.key, 
                ...data, 
                fullName: profile.fullName, 
                profilePic: profile.profilePic,
                isVerified: profile.isVerified // Badge status added here
            }); 
        });

        let newPosts = tempPosts.filter(p => (now - p.timestamp) < oneDay);
        let oldPosts = tempPosts.filter(p => (now - p.timestamp) >= oneDay);
        
        allPostsData = [...shuffle(newPosts), ...shuffle(oldPosts)];
        renderFeed(allPostsData);
    });
}

// 3. Updated Render Feed (Post-e badge add kora hoyeche)
function renderFeed(posts) {
    const container = document.getElementById('postsContainer');
    container.innerHTML = posts.map(post => {
        const isLiked = post.likedBy && post.likedBy[auth.currentUser.uid];
        const hasBg = post.background && post.background !== "none";
        const likeCount = post.likedBy ? Object.keys(post.likedBy).length : 0;
        const commentCount = post.comments ? Object.keys(post.comments).length : 0;
        const isLong = post.text.length > 300;
        const isBoxOpen = openCommentSections[post.id] ? '' : 'hidden';
        
        // Post Owner verification check
        const verifiedIcon = post.isVerified ? blueBadge : "";

        return `
        <div class="post-card" id="card-${post.id}">
            <div class="p-3 flex items-center">
                <div class="relative cursor-pointer" onclick="goToProfile('${post.uid}')">
                    <img src="${post.profilePic || 'https://ui-avatars.com/api/?name='+post.fullName}" class="h-10 w-10 rounded-full border">
                    <div id="stat-${post.id}" class="status-dot offline"></div>
                </div>
                <div class="ml-2">
                    <p class="text-[15px] font-bold text-[#050505] hover:underline cursor-pointer" onclick="goToProfile('${post.uid}')">
                        ${post.fullName}${verifiedIcon}
                    </p>
                    <p class="text-[#65676b] text-[12px]">${new Date(post.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                </div>
            </div>

            <div id="ptext-${post.id}" class="${hasBg ? 'colored-content' : 'px-4 pb-1 text-[15px] ' + (isLong ? 'text-limit' : '')}" style="background: ${hasBg ? post.background : 'transparent'}">
                ${escape(post.text)}
            </div>
            ${isLong && !hasBg ? `<button class="px-4 text-blue-600 font-bold text-sm mb-2" onclick="toggleText('${post.id}', this)">See more</button>` : ''}

            <div class="px-4 py-2 flex justify-between items-center text-[#65676b] text-[13px] border-b mx-3">
                <span class="flex items-center"><img src="https://cdn-icons-png.flaticon.com/512/2107/2107845.png" class="w-4 h-4 mr-1"> ${likeCount}</span>
                <span class="cursor-pointer font-medium" onclick="toggleComments('${post.id}')">${commentCount} comments</span>
            </div>

            <div class="px-2 py-1 flex">
                <button onclick="handleLike('${post.id}')" class="action-btn ${isLiked ? 'active-like' : ''}">
                    <i class="${isLiked ? 'fas' : 'far'} fa-thumbs-up text-lg"></i> Like
                </button>
                <button onclick="toggleComments('${post.id}')" class="action-btn">
                    <i class="far fa-comment text-lg"></i> Comment
                </button>
            </div>

            <div id="sec-${post.id}" class="${isBoxOpen} border-t bg-gray-50/50">
                <div class="comment-container" id="list-${post.id}">${renderComments(post.comments)}</div>
                <div class="p-3 flex gap-2 bg-white border-t">
                    <input type="text" id="in-${post.id}" placeholder="Write a comment..." class="bg-gray-100 flex-1 outline-none text-sm rounded-full px-4 py-2" onkeypress="if(event.key === 'Enter') postComment('${post.id}')">
                    <button onclick="postComment('${post.id}')" class="text-[#1877F2]"><i class="fas fa-paper-plane text-lg"></i></button>
                </div>
            </div>
        </div>`;
    }).join('');
    
    posts.forEach(p => listenStatus(p.uid, `stat-${p.id}`));
}

// 4. Updated Render Comments (Comment-e badge add kora hoyeche)
function renderComments(comments) {
    if (!comments) return `<p class="text-center text-xs text-gray-400 py-4">No comments yet.</p>`;
    const list = Object.values(comments).sort((a, b) => b.timestamp - a.timestamp);
    return list.map(c => {
        // Commenter profile verification status check from userCache
        const profile = userCache[c.uid] || { isVerified: false };
        const verifiedIcon = profile.isVerified ? blueBadge : "";

        return `
        <div class="flex gap-2">
            <img src="${c.userPhoto || 'https://ui-avatars.com/api/?name='+c.userName}" class="h-8 w-8 rounded-full cursor-pointer" onclick="goToProfile('${c.uid}')">
            <div class="comment-bubble">
                <p class="text-[12px] font-bold hover:underline cursor-pointer" onclick="goToProfile('${c.uid}')">
                    ${escape(c.userName)}${verifiedIcon}
                </p>
                <p class="text-[13px] text-gray-800">${escape(c.text)}</p>
            </div>
        </div>`;
    }).join('');
}</script>
</body>
</html>