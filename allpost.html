<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SocialTrade - Pro Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Arial, sans-serif; overflow-anchor: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        .post-card { background: white; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .colored-content { min-height: 280px; display: flex; align-items: center; justify-content: center; padding: 30px; text-align: center; font-size: 1.6rem; font-weight: 800; color: white; border-radius: 4px; }
        .action-btn { flex: 1; padding: 10px 0; font-size: 13px; font-weight: 600; color: #65676b; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; }
        .active-like { color: #1877F2 !important; }
        .status-dot { width: 12px; height: 12px; border: 2px solid white; border-radius: 50%; position: absolute; bottom: 2px; right: 2px; }
        .online { background-color: #31a24c; }
        .offline { background-color: #90949c; }
        .follow-btn { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 4px; margin-left: 6px; cursor: pointer; }
        .verified-badge { width: 15px; height: 15px; margin-left: 4px; display: inline-block; vertical-align: middle; }
        
        #commentDrawer { position: fixed; bottom: 0; left: 0; right: 0; height: 85%; background: white; z-index: 5000; border-radius: 20px 20px 0 0; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1); display: flex; flex-direction: column; box-shadow: 0 -5px 25px rgba(0,0,0,0.2); }
        #commentDrawer.open { transform: translateY(0); }
        .comment-bubble { background: #f0f2f5; border-radius: 18px; padding: 8px 14px; max-width: 85%; }
        
        #smartOverlay { display: none; position: fixed; inset: 0; z-index: 10000; background: white; transform: translateY(100%); transition: transform 0.4s ease; }
        #smartOverlay.show { display: block; transform: translateY(0); }
        #smartIframe { width: 100%; height: calc(100% - 50px); border: none; }
    </style>
</head>
<body class="pb-10">

    <div id="smartOverlay">
        <div style="display:none" class="h-[50px] border-b flex items-center px-4 bg-white sticky top-0">
            <button onclick="window.history.back()" class="text-[#1877F2] font-bold"><i class="fas fa-arrow-left"></i> Back</button>
            <span id="overlayTitle" class="ml-4 font-bold text-gray-700 truncate">SocialTrade</span>
        </div>
        <iframe id="smartIframe" src=""></iframe>
    </div>

    <div id="commentDrawer">
        <div class="h-1.5 w-12 bg-gray-300 rounded-full mx-auto mt-3 mb-2 cursor-pointer" onclick="window.history.back()"></div>
        <div class="flex justify-between items-center px-4 py-2 border-b">
            <h3 class="font-bold text-lg">Comments</h3>
            <button onclick="window.history.back()" class="text-gray-500 text-xl"><i class="fas fa-times"></i></button>
        </div>
        <div id="commentList" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50"></div>
        <div class="p-3 border-t bg-white flex items-center gap-2">
            <input type="text" id="commentInput" placeholder="Write a comment..." class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm outline-none border focus:border-blue-400">
            <button onclick="submitComment()" class="text-[#1877F2] font-bold px-2"><i class="fas fa-paper-plane text-xl"></i></button>
        </div>
    </div>

    <div id="pushNotification" class="hidden"></div>

    <div class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-[500px] mx-auto p-3 flex items-center gap-3">
            <h1 class="text-2xl font-bold text-[#1877F2] cursor-pointer" onclick="location.reload()"><i class="fas fa-home"></i></h1>
            <div class="relative flex-1">
                <input type="text" id="searchInput" oninput="renderFeed()" placeholder="Search..." class="w-full bg-gray-100 rounded-full py-2 px-10 text-[14px] outline-none border border-transparent focus:bg-white focus:border-blue-300">
                <i class="fas fa-search absolute left-4 top-3 text-gray-400 text-sm"></i>
            </div>
            <div class="flex gap-4 items-center">
                <a href="javascript:void(0)" onclick="openSmartPopup('sms-list.html', 'Messenger')"><i class="fab fa-facebook-messenger text-xl text-[#0084FF]"></i></a>
                <a href="javascript:void(0)" onclick="openSmartPopup('profile.html?uid=' + myUid, 'My Profile')"><i class="fas fa-user-circle text-2xl text-gray-500"></i></a>
            </div>
        </div>
    </div>

    <div class="max-w-[500px] mx-auto p-2" id="postsContainer">
        <div class="text-center py-20 text-gray-400"><i class="fas fa-spinner fa-spin text-3xl"></i></div>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA", authDomain: "social-media-5e6c8.firebaseapp.com", databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com/", projectId: "social-media-5e6c8" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), auth = firebase.auth();
    const blueBadge = `<svg class="verified-badge" viewBox="0 0 24 24" fill="#1877F2" xmlns="http://www.w3.org/2000/svg"><path d="M23.389 10.519L20.897 7.741L21.242 4.025L17.591 3.201L15.681 0L12 1.583L8.319 0L6.409 3.201L2.758 4.015L3.103 7.741L0.611 10.519L2.758 13.297L2.413 17.023L6.064 17.847L7.974 21.048L11.655 19.465L15.336 21.048L17.246 17.847L20.897 17.023L20.552 13.297L22.699 10.519H23.389ZM10.526 15.111L6.776 11.361L8.243 9.894L10.526 12.177L15.757 6.946L17.224 8.413L10.526 15.111Z"/></svg>`;

    let allPostsData = [], userCache = {}, myFollowing = {}, myUid = "", currentPostId = "";

    auth.onAuthStateChanged(user => {
        if (user) {
            myUid = user.uid;
            // logic: No status set/update here (Self-Active off)
            checkUserLock(user.uid);
        } else { window.location.href = "login.html"; }
    });

    function checkUserLock(uid) {
        db.ref(`user-info/${uid}/profile`).on('value', snap => {
            if (snap.val()?.status === 'blocked') {
                window.location.href = "error.html";
                return;
            }
            loadBaseData(); 
        });
    }

    function loadBaseData() {
        db.ref('user-info').on('value', uSnap => {
            uSnap.forEach(u => { userCache[u.key] = u.val().profile; });
            db.ref(`user-following/${myUid}`).on('value', fSnap => {
                myFollowing = fSnap.val() || {};
                db.ref('posts').on('value', pSnap => {
                    allPostsData = [];
                    pSnap.forEach(p => {
                        const d = p.val();
                        const u = userCache[d.uid] || { fullName: "User" };
                        allPostsData.push({ id: p.key, ...d, ...u, uid: d.uid });
                    });
                    allPostsData.sort((a,b) => b.timestamp - a.timestamp);
                    renderFeed();
                });
            });
        });
    }

    function renderFeed() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const container = document.getElementById('postsContainer');
        const filtered = allPostsData.filter(p => 
            p.fullName.toLowerCase().includes(term) || 
            (p.text && p.text.toLowerCase().includes(term))
        );

        if (filtered.length === 0) {
            container.innerHTML = `<div class="text-center py-20 text-gray-500">No results found</div>`;
            return;
        }

        container.innerHTML = filtered.map(post => {
            const isLiked = post.likedBy && post.likedBy[myUid];
            const hasBg = post.background && post.background !== "none";
            const badge = post.isVerified ? blueBadge : "";
            let followBtn = (post.uid !== myUid) ? 
                `<button onclick="handleFollow('${post.uid}', event)" class="follow-btn ${myFollowing[post.uid] ? 'text-gray-400' : 'text-blue-500'}">${myFollowing[post.uid] ? 'Following' : 'Follow'}</button>` : "";

            return `
            <div class="post-card">
                <div class="p-3 flex items-center gap-2">
                    <div class="relative cursor-pointer" onclick="openSmartPopup('profile.html?uid=${post.uid}', '${post.fullName}')">
                        <img src="${post.profilePic || 'https://ui-avatars.com/api/?name='+post.fullName}" class="h-10 w-10 rounded-full border">
                        <div id="stat-${post.id}" class="status-dot offline"></div>
                    </div>
                    <div class="flex-1">
                        <p class="text-[14px] font-bold flex items-center">${post.fullName}${badge}${followBtn}</p>
                        <p class="text-[11px] text-gray-500">${timeAgo(post.timestamp)} ago</p>
                    </div>
                </div>
                <div class="${hasBg ? 'colored-content' : 'px-4 pb-3 text-[15px]'}" style="background:${hasBg ? post.background : 'white'}">${post.text || ''}</div>
                <div class="px-4 py-2 flex justify-between text-[12px] text-gray-500 border-b mx-3">
                    <span><i class="fas fa-thumbs-up text-blue-500"></i> ${post.likedBy ? Object.keys(post.likedBy).length : 0}</span>
                    <span onclick="openComments('${post.id}')" class="cursor-pointer hover:underline">${post.comments ? Object.keys(post.comments).length : 0} comments</span>
                </div>
                <div class="px-2 py-1 flex">
                    <button onclick="handleLike('${post.id}')" class="action-btn ${isLiked ? 'active-like' : ''}"><i class="${isLiked?'fas':'far'} fa-thumbs-up"></i> Like</button>
                    <button onclick="openComments('${post.id}')" class="action-btn"><i class="far fa-comment"></i> Comment</button>
                    <button onclick="openSmartPopup('chat.html?uid=${post.uid}', '${post.fullName}')" class="action-btn"><i class="far fa-paper-plane"></i> Message</button>
                </div>
            </div>`;
        }).join('');
        filtered.forEach(p => observeStatus(p.uid, `stat-${p.id}`));
    }

    function observeStatus(uid, dotId) {
        db.ref(`status/${uid}`).on('value', snap => {
            const dot = document.getElementById(dotId);
            if(!dot) return;
            const data = snap.val();
            const isOnline = data && (data.state === 'online' || Date.now() < data.last);
            dot.className = `status-dot ${isOnline ? 'online' : 'offline'}`;
        });
    }

    // --- Comment Functions ---
    function openComments(pid) {
        currentPostId = pid;
        document.getElementById('commentDrawer').classList.add('open');
        document.body.style.overflow = "hidden";
        history.pushState({ popup: true }, "");
        
        db.ref(`posts/${pid}/comments`).on('value', snap => {
            const list = document.getElementById('commentList');
            const arr = []; snap.forEach(c => { arr.push(c.val()); });
            arr.sort((a,b) => b.timestamp - a.timestamp);
            
            list.innerHTML = arr.map(c => {
                const u = userCache[c.uid] || { fullName: "User" };
                return `<div class="flex items-start gap-2">
                    <img onclick="openSmartPopup('profile.html?uid=${c.uid}', '${u.fullName}')" src="${u.profilePic || 'https://ui-avatars.com/api/?name='+u.fullName}" class="w-8 h-8 rounded-full border cursor-pointer">
                    <div class="flex-1">
                        <div class="comment-bubble inline-block">
                            <p class="text-[12px] font-bold text-gray-800">${u.fullName}</p>
                            <p class="text-[13px] text-gray-700">${c.text}</p>
                        </div>
                        <p class="text-[10px] text-gray-500 ml-2 mt-1">${timeAgo(c.timestamp)} ago</p>
                    </div>
                </div>`;
            }).join('') || '<div class="text-center py-10 text-gray-400">No comments yet</div>';
        });
    }

    function submitComment() {
        const inp = document.getElementById('commentInput');
        if(inp.value.trim() && currentPostId) {
            db.ref(`posts/${currentPostId}/comments`).push({ 
                uid: myUid, 
                text: inp.value.trim(), 
                timestamp: Date.now() 
            });
            inp.value = "";
        }
    }

    function timeAgo(ts) {
        const s = Math.floor((Date.now() - ts) / 1000);
        if (s < 60) return "Just now";
        if (s < 3600) return Math.floor(s/60) + "m";
        if (s < 86400) return Math.floor(s/3600) + "h";
        return Math.floor(s/86400) + "d";
    }

    function openSmartPopup(url, title) {
        document.getElementById('overlayTitle').innerText = title;
        document.getElementById('smartIframe').src = url;
        const ov = document.getElementById('smartOverlay');
        ov.style.display = 'block';
        setTimeout(() => ov.classList.add('show'), 10);
        document.body.style.overflow = "hidden";
        history.pushState({ popup: true }, "");
    }

    function closeSmartPopup() {
        const ov = document.getElementById('smartOverlay');
        ov.classList.remove('show');
        document.body.style.overflow = "auto";
        setTimeout(() => { ov.style.display = 'none'; document.getElementById('smartIframe').src = ""; }, 400);
    }

    window.onpopstate = function() {
        if (document.getElementById('smartOverlay').classList.contains('show')) closeSmartPopup();
        else if (document.getElementById('commentDrawer').classList.contains('open')) {
            document.getElementById('commentDrawer').classList.remove('open');
            document.body.style.overflow = "auto";
        }
    };

    async function handleLike(pid) {
        const ref = db.ref(`posts/${pid}/likedBy/${myUid}`);
        (await ref.get()).exists() ? ref.remove() : ref.set(true);
    }

    async function handleFollow(tUid, e) {
        e.stopPropagation();
        const ref = db.ref(`user-following/${myUid}/${tUid}`);
        (await ref.get()).exists() ? ref.remove() : ref.set(true);
    }
</script>
</body>
</html>
