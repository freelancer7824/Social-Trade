<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialTrade - Pro Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Helvetica, Arial, sans-serif; overflow-anchor: none; }
        .post-card { background: white; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .colored-content { min-height: 300px; display: flex; align-items: center; justify-content: center; padding: 30px; text-align: center; font-size: 1.8rem; font-weight: 800; color: white; border-radius: 4px; }
        .comment-bubble { background: #f0f2f5; border-radius: 18px; padding: 8px 12px; max-width: 85%; }
        .action-btn { flex: 1; padding: 8px 0; font-size: 14px; font-weight: 600; color: #65676b; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .action-btn:hover { background: #f2f2f2; border-radius: 4px; }
        .active-like { color: #1877F2 !important; }
        .status-dot { width: 12px; height: 12px; border: 2px solid white; border-radius: 50%; position: absolute; bottom: 2px; right: 2px; }
        .online { background-color: #31a24c; }
        .offline { background-color: #90949c; }

        /* Follow Button Style */
        .follow-btn { font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 6px; margin-left: 10px; cursor: pointer; }
        .btn-follow { color: #1877F2; border: 1px solid #1877F2; }
        .btn-following { color: #65676b; background: #e4e6eb; }

        /* Iframe Modal Overlay */
        #profileOverlay { display: none; position: fixed; inset: 0; z-index: 1000; background: white; }
        #profileIframe { width: 100%; height: calc(100% - 50px); border: none; }
    </style>
</head>
<body class="pb-10">

    <div id="profileOverlay">
        <div class="h-[50px] border-b flex items-center px-4 bg-white shadow-sm">
            <button onclick="closeProfile()" class="text-[#1877F2] font-bold flex items-center gap-2">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <span id="overlayTitle" class="ml-4 font-bold text-gray-700">Profile</span>
        </div>
        <iframe id="profileIframe" src=""></iframe>
    </div>

    <div class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-[500px] mx-auto p-3 flex items-center gap-3">
            <h1 class="text-2xl font-bold text-[#1877F2] cursor-pointer" onclick="location.reload()">
                <i class="fas fa-home"></i>
            </h1>
            
            <div class="relative flex-1">
                <input type="text" id="searchInput" placeholder="Search friends..." 
                    class="w-full bg-gray-100 rounded-full py-1.5 px-10 text-[14px] outline-none border border-transparent focus:border-blue-300">
                <i class="fas fa-search absolute left-4 top-2.5 text-gray-400 text-sm"></i>
            </div>

            <div class="flex gap-4 items-center text-gray-600">
                <a href="sms-list.html"><i class="fab fa-facebook-messenger text-xl text-[#0084FF]"></i></a>
                <a href="javascript:void(0)" onclick="openProfile(auth.currentUser.uid, 'My Profile')">
                    <i class="fas fa-user-circle text-2xl"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="max-w-[500px] mx-auto p-2" id="postsContainer">
        <div class="text-center py-20 text-gray-400"><i class="fas fa-spinner fa-spin text-3xl"></i></div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA",
        authDomain: "social-media-5e6c8.firebaseapp.com",
        databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com/",
        projectId: "social-media-5e6c8",
        storageBucket: "social-media-5e6c8.firebasestorage.app",
        messagingSenderId: "897473713729",
        appId: "1:897473713729:web:7ba552ed4c1be8754418c0"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const blueBadge = `<svg class="inline-block w-[14px] h-[14px] ml-1 mb-0.5 text-[#1877F2]" viewBox="0 0 24 24" fill="currentColor"><path d="M9.707 19.121a.997.997 0 01-1.414 0l-5.646-5.647a1.5 1.5 0 010-2.121l.707-.707a1.5 1.5 0 012.121 0L9 14.167l8.528-8.527a1.5 1.5 0 012.122 0l.707.707a1.5 1.5 0 010 2.121l-9.944 9.944a1 1 0 01-.706.709z" /></svg>`;

    let allPostsData = [];
    let userCache = {};
    let myFollowing = {};
    let openCommentSections = {};

    function timeAgo(ts) {
        const s = Math.floor((new Date() - ts) / 1000);
        if (s < 60) return "Just now";
        if (s < 3600) return Math.floor(s/60) + "m";
        if (s < 86400) return Math.floor(s/3600) + "h";
        return Math.floor(s/86400) + "d";
    }

    // --- Iframe System ---
    function openProfile(uid, name) {
        document.getElementById('overlayTitle').innerText = name;
        document.getElementById('profileIframe').src = `profile.html?uid=${uid}`;
        document.getElementById('profileOverlay').style.display = 'block';
        document.body.style.overflow = "hidden";
        history.pushState({view: 'profile'}, "");
    }

    function closeProfile() {
        document.getElementById('profileOverlay').style.display = 'none';
        document.getElementById('profileIframe').src = "";
        document.body.style.overflow = "auto";
    }

    window.onpopstate = () => closeProfile();

    // --- Follow Logic ---
    async function handleFollow(targetUid, event) {
        event.stopPropagation();
        const myUid = auth.currentUser.uid;
        const isFollowing = myFollowing[targetUid];
        if(isFollowing) {
            await db.ref(`user-following/${myUid}/${targetUid}`).remove();
            await db.ref(`user-followers/${targetUid}/${myUid}`).remove();
        } else {
            await db.ref(`user-following/${myUid}/${targetUid}`).set(true);
            await db.ref(`user-followers/${targetUid}/${myUid}`).set(true);
        }
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            db.ref(`status/${user.uid}`).set({ state: 'online', last: Date.now() });
            db.ref(`status/${user.uid}`).onDisconnect().set({ state: 'offline', last: Date.now() });
            
            db.ref(`user-following/${user.uid}`).on('value', snap => {
                myFollowing = snap.val() || {};
                renderFeed(); 
            });

            loadData();
        } else { window.location.href = "login.html"; }
    });

    function loadData() {
        db.ref('user-info').on('value', uSnap => {
            userCache = {};
            uSnap.forEach(u => { userCache[u.key] = u.val().profile; });
            
            db.ref('posts').on('value', pSnap => {
                allPostsData = [];
                pSnap.forEach(post => {
                    const d = post.val();
                    const p = userCache[d.uid] || { fullName: "User" };
                    allPostsData.push({ id: post.key, ...d, fullName: p.fullName, profilePic: p.profilePic, isVerified: p.isVerified });
                });
                allPostsData.sort((a,b) => b.timestamp - a.timestamp);
                renderFeed();
            });
        });
    }

    function renderFeed() {
        const container = document.getElementById('postsContainer');
        const search = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allPostsData.filter(p => p.fullName.toLowerCase().includes(search));

        container.innerHTML = filtered.map(post => {
            const isLiked = post.likedBy && post.likedBy[auth.currentUser.uid];
            const hasBg = post.background && post.background !== "none";
            const isBoxOpen = openCommentSections[post.id] ? '' : 'hidden';

            let followHtml = "";
            if(post.isVerified && post.uid !== auth.currentUser.uid) {
                const isFollowing = myFollowing[post.uid];
                followHtml = `<button onclick="handleFollow('${post.uid}', event)" class="follow-btn ${isFollowing ? 'btn-following' : 'btn-follow'}">${isFollowing ? 'Following' : 'Follow'}</button>`;
            }

            return `
            <div class="post-card">
                <div class="p-3 flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="relative cursor-pointer" onclick="openProfile('${post.uid}', '${post.fullName}')">
                            <img src="${post.profilePic || 'https://ui-avatars.com/api/?name='+post.fullName}" class="h-10 w-10 rounded-full border">
                            <div id="stat-${post.id}" class="status-dot offline"></div>
                        </div>
                        <div class="ml-2">
                            <div class="flex items-center">
                                <p class="text-[15px] font-bold cursor-pointer" onclick="openProfile('${post.uid}', '${post.fullName}')">${post.fullName}${post.isVerified ? blueBadge : ""}</p>
                                ${followHtml}
                            </div>
                            <p class="text-[#65676b] text-[12px]">${timeAgo(post.timestamp)} ago</p>
                        </div>
                    </div>
                </div>

                <div class="${hasBg ? 'colored-content' : 'px-4 pb-2 text-[16px]'}" style="background: ${hasBg ? post.background : 'transparent'}">
                    ${post.text}
                </div>

                <div class="px-4 py-2 flex justify-between text-[#65676b] text-[13px] border-b mx-3">
                    <span><i class="fas fa-thumbs-up text-blue-500"></i> ${post.likedBy ? Object.keys(post.likedBy).length : 0}</span>
                    <span class="cursor-pointer" onclick="toggleComments('${post.id}')">${post.comments ? Object.keys(post.comments).length : 0} comments</span>
                </div>

                <div class="px-2 py-1 flex">
                    <button onclick="handleLike('${post.id}')" class="action-btn ${isLiked ? 'active-like' : ''}"><i class="${isLiked ? 'fas' : 'far'} fa-thumbs-up"></i> Like</button>
                    <button onclick="toggleComments('${post.id}')" class="action-btn"><i class="far fa-comment"></i> Comment</button>
                </div>

                <div id="sec-${post.id}" class="${isBoxOpen} border-t bg-gray-50/50">
                    <div class="p-3 space-y-3 max-h-80 overflow-y-auto">${renderComments(post.comments)}</div>
                    <div class="p-3 flex gap-2 bg-white border-t">
                        <input type="text" id="in-${post.id}" placeholder="Write a comment..." class="bg-gray-100 flex-1 rounded-full px-4 py-2 text-sm outline-none" onkeypress="if(event.key === 'Enter') postComment('${post.id}')">
                        <button onclick="postComment('${post.id}')" class="text-[#1877F2] px-2"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>`;
        }).join('');
        filtered.forEach(p => listenStatus(p.uid, `stat-${p.id}`));
    }

    function renderComments(comments) {
        if (!comments) return `<p class="text-center text-xs text-gray-400 py-2">No comments yet.</p>`;
        return Object.values(comments).sort((a,b)=>b.timestamp-a.timestamp).map(c => {
            const p = userCache[c.uid] || { isVerified: false };
            return `
            <div class="flex gap-2">
                <img src="${c.userPhoto || 'https://ui-avatars.com/api/?name='+c.userName}" class="h-8 w-8 rounded-full cursor-pointer" onclick="openProfile('${c.uid}', '${c.userName}')">
                <div class="comment-bubble">
                    <p class="text-[12px] font-bold cursor-pointer" onclick="openProfile('${c.uid}', '${c.userName}')">${c.userName}${p.isVerified ? blueBadge : ""} <span class="font-normal text-gray-400">â€¢ ${timeAgo(c.timestamp)}</span></p>
                    <p class="text-[13px] text-gray-800">${c.text}</p>
                </div>
            </div>`;
        }).join('');
    }

    function listenStatus(uid, dotId) {
        db.ref(`status/${uid}`).on('value', snap => {
            const dot = document.getElementById(dotId);
            if (dot) dot.className = `status-dot ${snap.val() && snap.val().state === 'online' ? 'online' : 'offline'}`;
        });
    }

    async function handleLike(pid) {
        const ref = db.ref(`posts/${pid}/likedBy/${auth.currentUser.uid}`);
        const snap = await ref.get();
        snap.exists() ? await ref.remove() : await ref.set(true);
    }

    async function postComment(pid) {
        const input = document.getElementById(`in-${pid}`);
        const text = input.value.trim();
        if (!text) return;
        openCommentSections[pid] = true;
        const myProfile = userCache[auth.currentUser.uid] || {};
        await db.ref(`posts/${pid}/comments`).push({
            uid: auth.currentUser.uid, userName: myProfile.fullName || "User",
            userPhoto: myProfile.profilePic || "", text: text, timestamp: Date.now()
        });
        input.value = "";
    }

    function toggleComments(pid) {
        const el = document.getElementById(`sec-${pid}`);
        el.classList.toggle('hidden');
        openCommentSections[pid] = !el.classList.contains('hidden');
    }

    document.getElementById('searchInput').addEventListener('input', () => renderFeed());
</script>
</body>
</html>        await db.ref(`posts/${pid}/comments`).push({
            uid: auth.currentUser.uid, userName: myProfile.fullName || "User",
            userPhoto: myProfile.profilePic || "", text: text, timestamp: Date.now()
        });
        input.value = "";
    }

    function toggleComments(pid) {
        const el = document.getElementById(`sec-${pid}`);
        el.classList.toggle('hidden');
        openCommentSections[pid] = !el.classList.contains('hidden');
    }

    document.getElementById('searchInput').addEventListener('input', () => renderFeed());
</script>
</body>
</html>    }

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            db.ref(`user-info/${user.uid}/profile`).on('value', snap => currentUserData = snap.val());
            loadAllData();
        } else { window.location.href = "login.html"; }
    });

    function loadAllData() {
        // First get all user profiles for instant name loading
        db.ref('user-info').on('value', userSnap => {
            userSnap.forEach(u => {
                userCache[u.key] = u.val().profile;
            });
            startFeedListener();
        });
    }

    function startFeedListener() {
        db.ref('posts').on('value', snapshot => {
            let tempPosts = [];
            snapshot.forEach(child => { 
                const data = child.val();
                const profile = userCache[data.uid] || { fullName: "User", profilePic: "" };
                tempPosts.push({ id: child.key, ...data, fullName: profile.fullName, profilePic: profile.profilePic }); 
            });

            // LOGIC: New posts priority + Random Shuffle for others
            // Sort by time first
            tempPosts.sort((a, b) => b.timestamp - a.timestamp);
            
            let newest = tempPosts.slice(0, 5); // Sobcheye notun 5 ta post shob somoy upore
            let others = tempPosts.slice(5);    // Baki shob post
            
            // Randomly shuffle 'others' jate prottek user alada order dekhe
            others = shuffle(others);
            
            allPostsData = [...newest, ...others];
            renderFeed(allPostsData);
        });
    }

    function renderFeed(posts) {
        const container = document.getElementById('postsContainer');
        container.innerHTML = posts.map(post => {
            const isLiked = post.likedBy && post.likedBy[auth.currentUser.uid];
            const hasBg = post.background && post.background !== "none";
            const likeCount = post.likedBy ? Object.keys(post.likedBy).length : 0;
            const commentCount = post.comments ? Object.keys(post.comments).length : 0;
            const isLong = post.text.length > 300;
            const isBoxOpen = openCommentSections[post.id] ? '' : 'hidden';

            return `
            <div class="post-card" id="card-${post.id}">
                <div class="p-3 flex items-center">
                    <div class="relative cursor-pointer" onclick="goToProfile('${post.uid}')">
                        <img src="${post.profilePic || 'https://ui-avatars.com/api/?name='+post.fullName}" class="h-10 w-10 rounded-full border">
                        <div id="stat-${post.id}" class="status-dot offline"></div>
                    </div>
                    <div class="ml-2">
                        <p class="text-[15px] font-bold text-[#050505] hover:underline cursor-pointer" onclick="goToProfile('${post.uid}')">${post.fullName}</p>
                        <p class="text-[#65676b] text-[12px]">${new Date(post.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                    </div>
                </div>

                <div id="ptext-${post.id}" class="${hasBg ? 'colored-content' : 'px-4 pb-1 text-[15px] ' + (isLong ? 'text-limit' : '')}" style="background: ${hasBg ? post.background : 'transparent'}">
                    ${escape(post.text)}
                </div>
                ${isLong && !hasBg ? `<button class="px-4 text-blue-600 font-bold text-sm mb-2" onclick="toggleText('${post.id}', this)">See more</button>` : ''}

                <div class="px-4 py-2 flex justify-between items-center text-[#65676b] text-[13px] border-b mx-3">
                    <span class="flex items-center"><img src="https://cdn-icons-png.flaticon.com/512/2107/2107845.png" class="w-4 h-4 mr-1"> ${likeCount}</span>
                    <span class="cursor-pointer font-medium" onclick="toggleComments('${post.id}')">${commentCount} comments</span>
                </div>

                <div class="px-2 py-1 flex">
                    <button onclick="handleLike('${post.id}')" class="action-btn ${isLiked ? 'active-like' : ''}">
                        <i class="${isLiked ? 'fas' : 'far'} fa-thumbs-up text-lg"></i> Like
                    </button>
                    <button onclick="toggleComments('${post.id}')" class="action-btn">
                        <i class="far fa-comment text-lg"></i> Comment
                    </button>
                </div>

                <div id="sec-${post.id}" class="${isBoxOpen} border-t bg-gray-50/50">
                    <div class="comment-container" id="list-${post.id}">${renderComments(post.comments)}</div>
                    <div class="p-3 flex gap-2 bg-white border-t">
                        <input type="text" id="in-${post.id}" placeholder="Write a comment..." class="bg-gray-100 flex-1 outline-none text-sm rounded-full px-4 py-2" onkeypress="if(event.key === 'Enter') postComment('${post.id}')">
                        <button onclick="postComment('${post.id}')" class="text-[#1877F2]"><i class="fas fa-paper-plane text-lg"></i></button>
                    </div>
                </div>
            </div>`;
        }).join('');
        
        posts.forEach(p => listenStatus(p.uid, `stat-${p.id}`));
    }

    // Navigation Logic: Profile visit without full reload
    function goToProfile(uid) {
        // Save scroll position before going
        sessionStorage.setItem('scrollPos', window.scrollY);
        window.location.href = `profile.html?uid=${uid}`;
    }

    // Restore scroll after returning
    window.onload = function() {
        const scrollPos = sessionStorage.getItem('scrollPos');
        if (scrollPos) {
            window.scrollTo(0, parseInt(scrollPos));
            sessionStorage.removeItem('scrollPos');
        }
    };

    function listenStatus(uid, dotId) {
        db.ref(`status/${uid}`).on('value', snap => {
            const dot = document.getElementById(dotId);
            if (dot) dot.className = `status-dot ${snap.val() === 'online' ? 'online' : 'offline'}`;
        });
    }

    document.getElementById('searchInput').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const filtered = allPostsData.filter(p => p.fullName.toLowerCase().includes(query));
        renderFeed(filtered);
    });

    async function handleLike(pid) {
        const ref = db.ref(`posts/${pid}/likedBy/${auth.currentUser.uid}`);
        const snap = await ref.get();
        snap.exists() ? await ref.remove() : await ref.set(true);
    }

    async function postComment(pid) {
        const input = document.getElementById(`in-${pid}`);
        const text = input.value.trim();
        if (!text || !currentUserData) return;
        openCommentSections[pid] = true;
        await db.ref(`posts/${pid}/comments`).push({
            uid: auth.currentUser.uid,
            userName: currentUserData.fullName,
            userPhoto: currentUserData.profilePic || "",
            text: text,
            timestamp: Date.now()
        });
        input.value = "";
    }

    function renderComments(comments) {
        if (!comments) return `<p class="text-center text-xs text-gray-400 py-4">No comments yet.</p>`;
        const list = Object.values(comments).sort((a, b) => b.timestamp - a.timestamp);
        return list.map(c => `
            <div class="flex gap-2">
                <img src="${c.userPhoto || 'https://ui-avatars.com/api/?name='+c.userName}" class="h-8 w-8 rounded-full cursor-pointer" onclick="goToProfile('${c.uid}')">
                <div class="comment-bubble">
                    <p class="text-[12px] font-bold hover:underline cursor-pointer" onclick="goToProfile('${c.uid}')">${escape(c.userName)}</p>
                    <p class="text-[13px] text-gray-800">${escape(c.text)}</p>
                </div>
            </div>`).join('');
    }

    function toggleComments(pid) {
        const sec = document.getElementById(`sec-${pid}`);
        if (sec.classList.contains('hidden')) {
            sec.classList.remove('hidden');
            openCommentSections[pid] = true;
        } else {
            sec.classList.add('hidden');
            delete openCommentSections[pid];
        }
    }

    function toggleText(pid, btn) {
        const el = document.getElementById(`ptext-${pid}`);
        el.classList.toggle('text-limit');
        btn.innerText = el.classList.contains('text-limit') ? "See more" : "See less";
    }

    function escape(str) {
        let div = document.createElement('div');
        div.innerText = str || "";
        return div.innerHTML;
    }
</script>
<script>
    // ... (Firebase config and init same thakbe)

    function startFeedListener() {
        db.ref('posts').on('value', snapshot => {
            let tempPosts = [];
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000; // 24 Ghonta millisecond-e

            snapshot.forEach(child => { 
                const data = child.val();
                const profile = userCache[data.uid] || { fullName: "User", profilePic: "" };
                tempPosts.push({ 
                    id: child.key, 
                    ...data, 
                    fullName: profile.fullName, 
                    profilePic: profile.profilePic 
                }); 
            });

            // 1. Post-guloke duiti vage vag kora (New vs Old)
            let newPosts = tempPosts.filter(p => (now - p.timestamp) < oneDay);
            let oldPosts = tempPosts.filter(p => (now - p.timestamp) >= oneDay);

            // 2. Notun post-gulo keo random shuffle koro jate ek-i post bar bar 1 number-e na thake
            newPosts = shuffle(newPosts);
            
            // 3. Purono post-gulo keo alomelo (random) koro
            oldPosts = shuffle(oldPosts);

            // 4. Final list: Age random notun post, tarpor random purono post
            allPostsData = [...newPosts, ...oldPosts];
            
            renderFeed(allPostsData);
        });
    }

    // Improved Shuffle Algorithm (Fisher-Yates) jate randomization aro valo hoy
    function shuffle(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [
            array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    // ... (renderFeed ebong baki function-gulo apnar code theke same thakbe)
</script>
<script>// 1. Blue Badge SVG Icon Constant (Eti script er ekdom upore ekbar rakhbe)
const blueBadge = `<svg class="inline-block w-[14px] h-[14px] ml-1 mb-0.5 text-[#1877F2]" viewBox="0 0 24 24" fill="currentColor"><path d="M9.707 19.121a.997.997 0 01-1.414 0l-5.646-5.647a1.5 1.5 0 010-2.121l.707-.707a1.5 1.5 0 012.121 0L9 14.167l8.528-8.527a1.5 1.5 0 012.122 0l.707.707a1.5 1.5 0 010 2.121l-9.944 9.944a1 1 0 01-.706.709z" /></svg>`;

// 2. Updated Feed Listener
function startFeedListener() {
    db.ref('posts').on('value', snapshot => {
        let tempPosts = [];
        const now = Date.now();
        const oneDay = 24 * 60 * 60 * 1000;

        snapshot.forEach(child => { 
            const data = child.val();
            // UserCache theke verification status check
            const profile = userCache[data.uid] || { fullName: "User", profilePic: "", isVerified: false };
            tempPosts.push({ 
                id: child.key, 
                ...data, 
                fullName: profile.fullName, 
                profilePic: profile.profilePic,
                isVerified: profile.isVerified // Badge status added here
            }); 
        });

        let newPosts = tempPosts.filter(p => (now - p.timestamp) < oneDay);
        let oldPosts = tempPosts.filter(p => (now - p.timestamp) >= oneDay);
        
        allPostsData = [...shuffle(newPosts), ...shuffle(oldPosts)];
        renderFeed(allPostsData);
    });
}

// 3. Updated Render Feed (Post-e badge add kora hoyeche)
function renderFeed(posts) {
    const container = document.getElementById('postsContainer');
    container.innerHTML = posts.map(post => {
        const isLiked = post.likedBy && post.likedBy[auth.currentUser.uid];
        const hasBg = post.background && post.background !== "none";
        const likeCount = post.likedBy ? Object.keys(post.likedBy).length : 0;
        const commentCount = post.comments ? Object.keys(post.comments).length : 0;
        const isLong = post.text.length > 300;
        const isBoxOpen = openCommentSections[post.id] ? '' : 'hidden';
        
        // Post Owner verification check
        const verifiedIcon = post.isVerified ? blueBadge : "";

        return `
        <div class="post-card" id="card-${post.id}">
            <div class="p-3 flex items-center">
                <div class="relative cursor-pointer" onclick="goToProfile('${post.uid}')">
                    <img src="${post.profilePic || 'https://ui-avatars.com/api/?name='+post.fullName}" class="h-10 w-10 rounded-full border">
                    <div id="stat-${post.id}" class="status-dot offline"></div>
                </div>
                <div class="ml-2">
                    <p class="text-[15px] font-bold text-[#050505] hover:underline cursor-pointer" onclick="goToProfile('${post.uid}')">
                        ${post.fullName}${verifiedIcon}
                    </p>
                    <p class="text-[#65676b] text-[12px]">${new Date(post.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                </div>
            </div>

            <div id="ptext-${post.id}" class="${hasBg ? 'colored-content' : 'px-4 pb-1 text-[15px] ' + (isLong ? 'text-limit' : '')}" style="background: ${hasBg ? post.background : 'transparent'}">
                ${escape(post.text)}
            </div>
            ${isLong && !hasBg ? `<button class="px-4 text-blue-600 font-bold text-sm mb-2" onclick="toggleText('${post.id}', this)">See more</button>` : ''}

            <div class="px-4 py-2 flex justify-between items-center text-[#65676b] text-[13px] border-b mx-3">
                <span class="flex items-center"><img src="https://cdn-icons-png.flaticon.com/512/2107/2107845.png" class="w-4 h-4 mr-1"> ${likeCount}</span>
                <span class="cursor-pointer font-medium" onclick="toggleComments('${post.id}')">${commentCount} comments</span>
            </div>

            <div class="px-2 py-1 flex">
                <button onclick="handleLike('${post.id}')" class="action-btn ${isLiked ? 'active-like' : ''}">
                    <i class="${isLiked ? 'fas' : 'far'} fa-thumbs-up text-lg"></i> Like
                </button>
                <button onclick="toggleComments('${post.id}')" class="action-btn">
                    <i class="far fa-comment text-lg"></i> Comment
                </button>
            </div>

            <div id="sec-${post.id}" class="${isBoxOpen} border-t bg-gray-50/50">
                <div class="comment-container" id="list-${post.id}">${renderComments(post.comments)}</div>
                <div class="p-3 flex gap-2 bg-white border-t">
                    <input type="text" id="in-${post.id}" placeholder="Write a comment..." class="bg-gray-100 flex-1 outline-none text-sm rounded-full px-4 py-2" onkeypress="if(event.key === 'Enter') postComment('${post.id}')">
                    <button onclick="postComment('${post.id}')" class="text-[#1877F2]"><i class="fas fa-paper-plane text-lg"></i></button>
                </div>
            </div>
        </div>`;
    }).join('');
    
    posts.forEach(p => listenStatus(p.uid, `stat-${p.id}`));
}

// 4. Updated Render Comments (Comment-e badge add kora hoyeche)
function renderComments(comments) {
    if (!comments) return `<p class="text-center text-xs text-gray-400 py-4">No comments yet.</p>`;
    const list = Object.values(comments).sort((a, b) => b.timestamp - a.timestamp);
    return list.map(c => {
        // Commenter profile verification status check from userCache
        const profile = userCache[c.uid] || { isVerified: false };
        const verifiedIcon = profile.isVerified ? blueBadge : "";

        return `
        <div class="flex gap-2">
            <img src="${c.userPhoto || 'https://ui-avatars.com/api/?name='+c.userName}" class="h-8 w-8 rounded-full cursor-pointer" onclick="goToProfile('${c.uid}')">
            <div class="comment-bubble">
                <p class="text-[12px] font-bold hover:underline cursor-pointer" onclick="goToProfile('${c.uid}')">
                    ${escape(c.userName)}${verifiedIcon}
                </p>
                <p class="text-[13px] text-gray-800">${escape(c.text)}</p>
            </div>
        </div>`;
    }).join('');
}</script>
</body>
</html>
