<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>User Panel - SocialTrade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        body { user-select: none; -webkit-tap-highlight-color: transparent; }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .content-frame { height: calc(100vh - 64px); width: 100%; border: none; }

        /* Notification Animation */
        #pushNotification { 
            position: fixed; top: -250px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 400px; z-index: 999999; 
            transition: all 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        #pushNotification.show { top: 20px; }
        .notif-card { 
            background: white; border-radius: 20px; padding: 15px; 
            box-shadow: 0 15px 50px rgba(0,0,0,0.2); border: 1px solid #f0f0f0; 
        }

        @media (max-width: 1023px) {
            #sidebar.closed { transform: translateX(-100%); }
            #sidebar.open { transform: translateX(0); }
        }
        @media (min-width: 1024px) {
            #sidebar { transform: translateX(0) !important; position: fixed !important; }
            .main-content { margin-left: 256px; } 
            #mobile-toggle { display: none; }
            #overlay { display: none !important; }
        }
    </style>

    <script>
        // Security: No Inspect Element
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.onkeydown = function(e) {
            if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 67 || e.keyCode == 74)) || (e.ctrlKey && e.keyCode == 85)) return false;
        };
    </script>
</head>
<body class="bg-gray-100 overflow-hidden">

    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" preload="auto"></audio>

    <div id="pushNotification">
        <div class="notif-card flex items-center gap-4 cursor-pointer shadow-xl" onclick="goToChat()">
            <div class="relative">
                <img id="notifImg" src="" class="w-12 h-12 rounded-full object-cover border-2 border-blue-500">
                <span class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] px-1.5 py-0.5 rounded-full border-2 border-white">New</span>
            </div>
            <div class="flex-1 overflow-hidden">
                <div class="flex justify-between items-center">
                    <span id="notifName" class="font-bold text-gray-800 text-sm">User</span>
                    <span class="text-[9px] text-blue-600 font-black uppercase">SocialTrade</span>
                </div>
                <p id="notifMsg" class="text-xs text-gray-500 truncate">New message...</p>
            </div>
        </div>
    </div>

    <nav class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-4 fixed top-0 w-full z-50">
        <div class="flex items-center">
            <button id="mobile-toggle" class="p-2 mr-3 text-gray-600 rounded-lg"><i class="fas fa-bars text-xl"></i></button>
            <span class="text-xl font-black text-blue-600 tracking-tighter uppercase">SOCIALTRADE</span>
        </div>
        <div class="flex items-center space-x-3">
            <div class="text-right">
                <p id="userNameDisplay" class="text-[12px] font-bold text-gray-800 leading-none">User</p>
                <p class="text-[9px] text-blue-500 font-bold uppercase">Trader Account</p>
            </div>
            <img id="userAvatar" src="" class="h-9 w-9 rounded-full border object-cover">
        </div>
    </nav>

    <div class="flex pt-16 h-screen">
        <aside id="sidebar" class="bg-white border-r border-gray-200 w-64 fixed inset-y-0 left-0 top-16 z-40 sidebar-scroll overflow-y-auto closed transition-transform duration-300">
            <div class="p-4 space-y-6">
                
                <div>
                    <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest px-4 mb-2">Main Dashboard</h4>
                    <ul class="space-y-1">
                        <li><a href="allpost.html" target="contentFrame" class="nav-link flex items-center px-4 py-3 text-sm font-bold text-blue-600 bg-blue-50 rounded-xl"><i class="fas fa-th-large mr-3 w-5"></i> Home Page</a></li>
                        <li><a href="marketplace.html" target="contentFrame" class="nav-link flex items-center px-4 py-3 text-sm font-bold text-gray-600 hover:bg-gray-50 rounded-xl"><i class="fas fa-shopping-basket mr-3 w-5"></i> Marketplace</a></li>
                    </ul>
                </div>

                <div>
                    <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest px-4 mb-2">Trading & Ads</h4>
                    <ul class="space-y-1">
                        <li><a href="newpost.html" target="contentFrame" class="nav-link flex items-center px-4 py-3 text-sm font-bold text-gray-600 hover:bg-gray-50 rounded-xl"><i class="fas fa-plus-circle mr-3 w-5 text-blue-500"></i> Create New Post</a></li>
                    <li><a href="my-gig.html" target="contentFrame" class="nav-link flex items-center px-4 py-3 text-sm font-bold text-gray-600 hover:bg-gray-50 rounded-xl"><i class="fas fa-list-check mr-3 w-5 text-purple-500"></i> Create New Gigs</a></li>
                    </ul>
                </div>

                <div>
                    <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest px-4 mb-2">Finance</h4>
                    <ul class="space-y-1">
                        <li><a href="overview.html" target="contentFrame" class="nav-link flex items-center px-4 py-3 text-sm font-bold text-gray-600 hover:bg-gray-50 rounded-xl"><i class="fas fa-wallet mr-3 w-5 text-orange-500"></i> My Wallet</a></li>
                        <li><a href="deposit_money.html" target="contentFrame" class="nav-link flex items-center px-4 py-3 text-sm font-bold text-gray-600 hover:bg-gray-50 rounded-xl"><i class="fas fa-arrow-down mr-3 w-5 text-green-500"></i> Deposit</a></li>
                        <li><a href="withdraw_money.html" target="contentFrame" class="nav-link flex items-center px-4 py-3 text-sm font-bold text-gray-600 hover:bg-gray-50 rounded-xl"><i class="fas fa-arrow-up mr-3 w-5 text-red-500"></i> Withdraw</a></li>
                    </ul>
                </div>

                <div>
                    <h4 class="text-[10px] font-black text-gray-400 uppercase tracking-widest px-4 mb-2">Personal</h4>
                    <ul class="space-y-1">
                        <li><a href="profile_settings.html" target="contentFrame" class="nav-link flex items-center px-4 py-3 text-sm font-bold text-gray-600 hover:bg-gray-50 rounded-xl"><i class="fas fa-user-gear mr-3 w-5 text-gray-500"></i> Settings</a></li>
                    </ul>
                </div>

                <div class="pt-4 border-t border-gray-100">
                    <button onclick="logout()" class="w-full flex items-center px-4 py-3 text-sm font-black text-red-500 hover:bg-red-50 rounded-xl transition"><i class="fas fa-sign-out-alt mr-3 w-5"></i> Logout</button>
                </div>
            </div>
        </aside>

        <main class="main-content flex-1 relative overflow-hidden transition-all duration-300">
            <div id="overlay" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-30 lg:hidden"></div>
            <iframe name="contentFrame" id="contentFrame" src="allpost.html" class="content-frame"></iframe>
        </main>
    </div>

<script>
    // Firebase Configuration
    const firebaseConfig = { apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA", authDomain: "social-media-5e6c8.firebaseapp.com", databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com/", projectId: "social-media-5e6c8" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), auth = firebase.auth();
    
    let myUid = "";

    // Presence Logic (Immediate Offline on Close)
    function managePresence(uid) {
        const statusRef = db.ref(`status/${uid}`);
        db.ref('.info/connected').on('value', snap => {
            if (snap.val() === true) {
                statusRef.set({ state: 'online', last: Date.now() });
                statusRef.onDisconnect().set({ state: 'offline', last: Date.now() });
            }
        });
    }

    // Smart Notification Logic (Firebase-Saved Tracking)
    // Smart Notification Logic (Updated for Image support)
    function listenNotifications(uid) {
        db.ref('chats').on('child_added', snap => {
            if (snap.key.includes(uid)) {
                db.ref(`chats/${snap.key}`).limitToLast(1).on('child_added', async mSnap => {
                    const m = mSnap.val();
                    const msgId = mSnap.key;
                    
                    if (m.senderId !== uid) {
                        const checkRef = db.ref(`user-info/${uid}/seen_notifications/${msgId}`);
                        const checkSnap = await checkRef.once('value');

                        if (!checkSnap.exists()) {
                            checkRef.set(true);

                            const uSnap = await db.ref(`user-info/${m.senderId}/profile`).once('value');
                            const user = uSnap.val() || {};
                            
                            // à¦‡à¦®à§‡à¦œ à¦®à§‡à¦¸à§‡à¦œ à¦šà§‡à¦• à¦•à¦°à¦¾à¦° à¦•à¦¨à§à¦¡à¦¿à¦¶à¦¨
                            let notificationText = m.text;
                            if (m.type === 'image') {
                                notificationText = "ðŸ“· Sent a photo";
                            }
                            
                            document.getElementById('notifSound').play().catch(() => {});
                            
                            // à¦ªà¦ªà¦†à¦ª à¦«à¦¾à¦‚à¦¶à¦¨à§‡ à¦Ÿà§‡à¦•à§à¦¸à¦Ÿà¦Ÿà¦¿ à¦ªà¦¾à¦ à¦¾à¦¨à§‹ à¦¹à¦šà§à¦›à§‡
                            showPopup(user.fullName || "New Message", notificationText, user.profilePic, m.senderId);
                        }
                    }
                });
            }
        });
    }

    let activeSenderId = "";
    function showPopup(name, msg, pic, sid) {
        activeSenderId = sid;
        document.getElementById('notifName').innerText = name;
        document.getElementById('notifMsg').innerText = msg; // à¦à¦–à¦¾à¦¨à§‡ à¦à¦–à¦¨ "Sent a photo" à¦¦à§‡à¦–à¦¾à¦¬à§‡
        document.getElementById('notifImg').src = pic || 'https://ui-avatars.com/api/?name=' + name;
        
        const pop = document.getElementById('pushNotification');
        pop.classList.add('show');
        setTimeout(() => { pop.classList.remove('show'); }, 5000);
    }

    function goToChat() {
        if(activeSenderId) {
            document.getElementById('contentFrame').src = `chat.html?uid=${activeSenderId}`;
            document.getElementById('pushNotification').classList.remove('show');
        }
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            myUid = user.uid;
            managePresence(user.uid);
            listenNotifications(user.uid);

            db.ref('user-info/' + user.uid).on('value', snap => {
                const data = snap.val();
                if (data?.profile) {
                    document.getElementById('userNameDisplay').innerText = data.profile.fullName;
                    document.getElementById('userAvatar').src = data.profile.profilePic || `https://ui-avatars.com/api/?name=${data.profile.fullName}`;
                }
            });
        } else { window.location.href = "login.html"; }
    });

    // Sidebar & UI Controls
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const mobileToggle = document.getElementById('mobile-toggle');

    function toggleSidebar() {
        sidebar.classList.toggle('closed');
        sidebar.classList.toggle('open');
        overlay.classList.toggle('hidden');
    }

    mobileToggle.onclick = toggleSidebar;
    overlay.onclick = toggleSidebar;

    // Auto-close sidebar on mobile after clicking link
    document.querySelectorAll('.nav-link').forEach(link => {
        link.onclick = () => { if (window.innerWidth < 1024) toggleSidebar(); };
    });

    function logout() {
        db.ref(`status/${myUid}`).set({ state: 'offline', last: Date.now() }).then(() => {
            auth.signOut().then(() => window.location.href = "login.html");
        });
    }
</script>
</body>
</html>
