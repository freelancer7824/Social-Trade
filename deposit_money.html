<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deposit Money - SocialTrade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        .history-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 250px;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 50;
        }
        .history-dropdown.show { display: block; }
        .status-pending { color: #f59e0b; }
        .status-confirmed { color: #10b981; }
        .status-rejected { color: #ef4444; }

        .method-card-active {
            background-color: #2563eb !important;
            border-color: #1e40af !important;
            color: white !important;
        }
        .method-card-active p { color: white !important; }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-6 min-h-screen">

    <div class="max-w-2xl mx-auto">
        <div class="mb-6 flex justify-between items-center relative">
            <div>
                <h1 class="text-2xl font-black text-gray-800">Deposit Money</h1>
                <p class="text-gray-500 text-sm font-medium">Add funds to your wallet.</p>
            </div>

            <div class="relative">
                <button onclick="toggleHistory()" class="bg-white border border-gray-200 px-4 py-2 rounded-2xl flex items-center space-x-2 shadow-sm hover:bg-gray-50 transition">
                    <i class="fas fa-history text-blue-600"></i>
                    <span class="text-sm font-bold text-gray-700">History</span>
                    <i class="fas fa-chevron-down text-[10px] text-gray-400"></i>
                </button>

                <div id="historyList" class="history-dropdown mt-2 p-2">
                    <p class="text-[10px] font-black text-gray-400 uppercase p-2 border-b">Recent Requests</p>
                    <div id="historyItems">
                        <p class="text-xs text-gray-400 p-4 text-center">No history found</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="methodsGrid" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-8">
            <p class="text-gray-400 text-xs animate-pulse">Loading methods...</p>
        </div>

        <div id="mainDepositForm" class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 hidden">
            <div class="mb-6 p-4 bg-blue-50 rounded-2xl border border-blue-100 relative">
                <div class="flex justify-between items-start mb-1">
                    <p id="methodTitle" class="text-[10px] font-bold text-blue-600 uppercase"></p>
                    <span id="methodStatus" class="bg-blue-600 text-white text-[9px] font-black px-2 py-0.5 rounded-md uppercase tracking-tighter"></span>
                </div>
                
                <div class="flex items-center justify-between">
                    <p id="methodInstruction" class="text-sm font-bold text-gray-700 truncate mr-2"></p>
                    <button onclick="copyAddress()" class="flex-shrink-0 bg-white p-2 rounded-lg border border-blue-100 text-blue-600 hover:bg-blue-100 transition shadow-sm">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                
                <p class="text-[10px] text-red-500 font-bold mt-2">Minimum: $<span id="minLimitText">0</span></p>
            </div>

            <form id="depositForm" class="space-y-4">
                <div id="currencyDiv" class="hidden">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase ml-2 mb-1">Currency</label>
                    <input type="text" id="fixedCurrency" value="USDT" readonly class="w-full px-4 py-3 rounded-xl border border-gray-100 bg-gray-50 font-bold outline-none">
                </div>
                <input type="number" id="amount" placeholder="Amount ($)" required class="w-full px-4 py-3 rounded-xl border border-gray-100 outline-none focus:ring-2 focus:ring-blue-500 font-bold">
                <input type="text" id="trxId" placeholder="Transaction ID / Hash" required class="w-full px-4 py-3 rounded-xl border border-gray-100 outline-none focus:ring-2 focus:ring-blue-500 font-bold">
                <button type="submit" id="submitBtn" class="w-full py-4 bg-blue-600 text-white font-black rounded-2xl shadow-lg hover:bg-blue-700 transition">SUBMIT REQUEST</button>
            </form>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA",
            authDomain: "social-media-5e6c8.firebaseapp.com",
            databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com/",
            projectId: "social-media-5e6c8",
            storageBucket: "social-media-5e6c8.firebasestorage.app",
            messagingSenderId: "897473713729",
            appId: "1:897473713729:web:7ba552ed4c1be8754418c0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let currentMethodData = null;
        let selectedMethodName = "";
        let currentRawAddress = "";

        function toggleHistory() {
            document.getElementById('historyList').classList.toggle('show');
        }

        // কপি ফাংশন
        function copyAddress() {
            if (!currentRawAddress) return;
            navigator.clipboard.writeText(currentRawAddress).then(() => {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'Address Copied!',
                    showConfirmButton: false,
                    timer: 1500
                });
            });
        }

        function selectMethod(key, data, element) {
            selectedMethodName = key;
            currentMethodData = data;
            currentRawAddress = data.address;

            document.querySelectorAll('.method-card').forEach(card => card.classList.remove('method-card-active'));
            element.classList.add('method-card-active');

            document.getElementById('mainDepositForm').classList.remove('hidden');
            document.getElementById('methodTitle').innerText = key;
            document.getElementById('methodInstruction').innerText = data.address;
            document.getElementById('minLimitText').innerText = data.min;

            // মেথড অনুযায়ী স্ট্যাটাস টেক্সট সেট করা
            const statusEl = document.getElementById('methodStatus');
            const nameLower = key.toLowerCase();
            if(nameLower.includes('binance')) statusEl.innerText = "UID / PAY ID";
            else if(nameLower.includes('bitget')) statusEl.innerText = "TRC20";
            else if(nameLower.includes('bkash') || nameLower.includes('nagad')) statusEl.innerText = "Send Money";
            else statusEl.innerText = "Address";
            
            if(nameLower.includes('binance') || nameLower.includes('bitget')) {
                document.getElementById('currencyDiv').classList.remove('hidden');
            } else {
                document.getElementById('currencyDiv').classList.add('hidden');
            }
        }

        db.ref('admin-settings/deposit-methods').on('value', snap => {
            const methods = snap.val();
            const grid = document.getElementById('methodsGrid');
            grid.innerHTML = "";
            let firstKey = null;

            for (let key in methods) {
                if (methods[key].active) {
                    if (!firstKey) firstKey = key;
                    const card = document.createElement('div');
                    card.id = "card-" + key;
                    card.className = "method-card p-3 bg-white border-2 border-transparent rounded-2xl cursor-pointer text-center shadow-sm hover:border-blue-100 transition-all";
                    card.innerHTML = `<p class="text-xs font-black text-gray-700">${key}</p>`;
                    card.onclick = () => selectMethod(key, methods[key], card);
                    grid.appendChild(card);
                }
            }
            if (firstKey) selectMethod(firstKey, methods[firstKey], document.getElementById("card-" + firstKey));
        });

        auth.onAuthStateChanged(user => {
            if(user) {
                db.ref('user-deposits/' + user.uid).on('value', snap => {
                    const container = document.getElementById('historyItems');
                    container.innerHTML = "";
                    if(!snap.exists()) {
                        container.innerHTML = `<p class="text-xs text-gray-400 p-4 text-center">No history found</p>`;
                        return;
                    }
                    snap.forEach(child => {
                        const data = child.val();
                        const item = document.createElement('div');
                        item.className = "p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-50 flex justify-between items-center";
                        item.onclick = () => showStatusPopup(data);
                        item.innerHTML = `
                            <div><p class="text-[11px] font-bold text-gray-800">${data.method}</p><p class="text-[9px] text-gray-400">${new Date(data.timestamp).toLocaleDateString()}</p></div>
                            <p class="text-[10px] font-bold status-${data.status} uppercase">${data.status}</p>
                        `;
                        container.prepend(item);
                    });
                });
            }
        });

        function showStatusPopup(data) {
            let statusColor = data.status === 'confirmed' ? '#10b981' : (data.status === 'rejected' ? '#ef4444' : '#f59e0b');
            Swal.fire({
                title: `<span style="color:${statusColor}">${data.status.toUpperCase()}</span>`,
                html: `<div class="text-left space-y-2 text-sm">
                    <div class="flex justify-between border-b py-1"><span>Method:</span> <b>${data.method}</b></div>
                    <div class="flex justify-between border-b py-1"><span>Amount:</span> <b>$${data.amount}</b></div>
                    <div class="flex justify-between border-b py-1"><span>TrxID:</span> <b class="text-[10px]">${data.trxId}</b></div>
                </div>`,
                icon: data.status === 'confirmed' ? 'success' : (data.status === 'rejected' ? 'error' : 'info'),
                confirmButtonColor: '#2563eb'
            });
        }

        document.getElementById('depositForm').onsubmit = async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('amount').value);
            if(amount < currentMethodData.min) return Swal.fire("Error", "Minimum deposit $" + currentMethodData.min, "error");
            const req = {
                uid: auth.currentUser.uid,
                userName: auth.currentUser.displayName || "User",
                method: selectedMethodName,
                amount: amount,
                trxId: document.getElementById('trxId').value,
                status: "pending",
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            const key = db.ref('deposit-requests').push().key;
            await db.ref('deposit-requests/' + key).set(req);
            await db.ref('user-deposits/' + auth.currentUser.uid + '/' + key).set(req);
            Swal.fire("Submitted", "Wait for admin approval.", "success");
            document.getElementById('depositForm').reset();
        };

        window.onclick = function(event) {
            if (!event.target.closest('.relative')) document.getElementById('historyList').classList.remove('show');
        }
    </script>
</body>
</html>