<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>User Profile - SocialTrade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        .post-card { background: white; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border: 1px solid #dddfe2; }
        .colored-content { min-height: 200px; display: flex; align-items: center; justify-content: center; padding: 25px; text-align: center; font-size: 1.3rem; font-weight: 800; color: white; border-radius: 4px; }
        .profile-pic { width: 110px; height: 110px; border-radius: 50%; border: 4px solid white; margin-top: -55px; object-fit: cover; background: #eee; position: relative; }
        .comment-bubble { background: #f0f2f5; border-radius: 15px; padding: 7px 12px; max-width: 85%; }
        .status-indicator { position: absolute; bottom: 8px; right: 8px; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; background: #ccc; }
        .status-online { background: #31a24c; }
        /* Cover photo smooth display */
        #coverImg { transition: opacity 0.3s ease-in; }
    </style>
</head>
<body class="pb-10">

    <div id="profileWrapper" class="max-w-[500px] mx-auto">
        <div class="bg-white border-b pb-4 shadow-sm">
            <div id="coverBg" class="h-40 bg-gradient-to-r from-blue-500 to-cyan-500 relative overflow-hidden">
                <img id="coverImg" class="w-full h-full object-cover hidden">
                <button onclick="history.back()" class="absolute top-3 left-3 text-white bg-black/30 w-8 h-8 rounded-full z-10 flex items-center justify-center"><i class="fas fa-arrow-left"></i></button>
            </div>
            
            <div class="px-4 text-center">
                <div class="relative inline-block">
                    <img id="userPic" src="" class="profile-pic mx-auto shadow-md">
                    <div id="activeDot" class="status-indicator"></div>
                </div>
                <h2 id="userName" class="text-xl font-bold mt-2 flex items-center justify-center">Loading...</h2>
                <p id="statusText" class="text-[10px] font-bold uppercase mb-1 text-gray-400">Offline</p>
                <p id="followerDisplay" class="text-[#1877F2] font-bold text-sm">0 Followers</p>
                <p id="userBio" class="text-gray-500 text-sm italic mt-1">...</p>
                <div id="profileActions" class="flex gap-2 mt-4 justify-center"></div>
            </div>
        </div>

        <div class="p-3">
            <h3 class="font-bold text-md text-gray-800 mb-3 border-b pb-2">Posts</h3>
            <div id="myPostsContainer"></div>
        </div>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA", authDomain: "social-media-5e6c8.firebaseapp.com", databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com/", projectId: "social-media-5e6c8" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), auth = firebase.auth();

    const blueBadge = `<svg class="inline-block w-4 h-4 ml-1 text-[#1877F2]" viewBox="0 0 24 24" fill="currentColor"><path d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.7l-3.61.81.34 3.7L1 12l2.44 2.79-.34 3.69 3.61.82 1.89 3.2L12 21.04l3.4 1.46 1.89-3.2 3.61-.82-.34-3.69L23 12zm-12.91 4.72l-3.8-3.81 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48-7.33 7.35z"/></svg>`;
    
    let targetUid = new URLSearchParams(window.location.search).get('uid'), myUid = "", userCache = {}, openComments = {};

    function timeAgo(ts) {
        if(!ts) return "";
        const s = Math.floor((Date.now() - ts) / 1000);
        if (s < 60) return "Just now";
        if (s < 3600) return Math.floor(s/60) + "m";
        if (s < 86400) return Math.floor(s/3600) + "h";
        return Math.floor(s/86400) + "d";
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            myUid = user.uid; if (!targetUid) targetUid = myUid;
            db.ref('user-info').on('value', snap => {
                userCache = {};
                snap.forEach(u => { userCache[u.key] = u.val().profile; });
                loadProfile(targetUid);
                loadPosts(targetUid);
            });
            const up = () => db.ref(`status/${myUid}`).set({ state: 'online', last_changed: Date.now() + 180000 });
            up(); setInterval(up, 60000);
            listenStatus(targetUid);
        } else { window.location.href = "login.html"; }
    });

    function loadProfile(uid) {
        db.ref(`user-info/${uid}/profile`).on('value', snap => {
            const d = snap.val() || {};
            const isV = d.isVerified === true || d.isVerified === "true";
            
            // Name & Verification
            document.getElementById('userName').innerHTML = (d.fullName || "User") + (isV ? blueBadge : "");
            
            // Profile Photo
            document.getElementById('userPic').src = d.profilePic || `https://ui-avatars.com/api/?name=${d.fullName}`;
            
            // Cover Photo Logic Updated
            const coverEl = document.getElementById('coverImg');
            if(d.coverPic) {
                coverEl.src = d.coverPic;
                coverEl.classList.remove('hidden');
            } else {
                coverEl.classList.add('hidden');
            }

            document.getElementById('userBio').innerText = d.bio || "No bio available";
            renderButtons(uid);
        });
        db.ref(`user-followers/${uid}`).on('value', s => {
            document.getElementById('followerDisplay').innerText = `${s.numChildren()} Followers`;
        });
    }

    // --- অন্যান্য ফাংশন আগের মতোই (Post, Comment, Like ইত্যাদি) ---
    function loadPosts(uid) {
        db.ref('posts').on('value', snap => {
            let posts = [];
            snap.forEach(c => { if(c.val().uid === uid) posts.push({id: c.key, ...c.val()}); });
            renderFeed(posts.sort((a,b)=>b.timestamp - a.timestamp));
        });
    }

    function renderFeed(posts) {
        const container = document.getElementById('myPostsContainer');
        container.innerHTML = posts.map(post => {
            const likes = post.likedBy ? Object.keys(post.likedBy).length : 0;
            const comments = post.comments ? Object.keys(post.comments).length : 0;
            const isLiked = post.likedBy && post.likedBy[myUid];
            const author = userCache[post.uid] || {};
            const isVAuthor = author.isVerified === true || author.isVerified === "true";
            const isHidden = openComments[post.id] ? '' : 'hidden';

            return `
            <div class="post-card">
                <div class="p-3 flex items-center justify-between border-b mx-1">
                    <div class="flex items-center gap-2">
                        <img src="${author.profilePic || 'https://ui-avatars.com/api/?name='+author.fullName}" class="w-9 h-9 rounded-full">
                        <div>
                            <p class="font-bold text-sm">${author.fullName || 'User'}${isVAuthor ? blueBadge : ""}</p>
                            <p class="text-[10px] text-gray-400">${timeAgo(post.timestamp)}</p>
                        </div>
                    </div>
                    ${post.uid === myUid ? `<button onclick="deletePost('${post.id}')" class="text-gray-300 p-2"><i class="fas fa-trash-alt"></i></button>` : ''}
                </div>
                <div class="${post.background && post.background !== 'none' ? 'colored-content' : 'px-4 py-3 text-sm'}" style="background: ${post.background || 'transparent'}">
                    ${post.text}
                </div>
                <div class="px-4 py-2 flex justify-between text-gray-500 text-[11px] border-b mx-2">
                    <span><i class="fas fa-thumbs-up text-blue-500"></i> ${likes}</span>
                    <span onclick="toggleBox('${post.id}')" class="cursor-pointer hover:underline">${comments} comments</span>
                </div>
                <div class="flex p-1">
                    <button onclick="handleLike('${post.id}')" class="flex-1 py-2 text-sm font-semibold flex items-center justify-center gap-2 ${isLiked ? 'text-blue-600': 'text-gray-500'}"><i class="${isLiked?'fas':'far'} fa-thumbs-up"></i> Like</button>
                    <button onclick="toggleBox('${post.id}')" class="flex-1 py-2 text-sm font-semibold flex items-center justify-center gap-2 text-gray-500"><i class="far fa-comment"></i> Comment</button>
                </div>
                <div id="box-${post.id}" class="${isHidden} border-t bg-gray-50 p-2">
                    <div class="space-y-3 mb-2 max-h-40 overflow-y-auto">${renderComments(post.comments, post.id)}</div>
                    <div class="flex gap-2">
                        <input type="text" id="in-${post.id}" placeholder="Write a comment..." class="flex-1 bg-white border rounded-full px-4 py-1.5 text-xs outline-none">
                        <button onclick="sendComment('${post.id}')" class="text-blue-600 px-2"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function renderComments(comments, pid) {
        if(!comments) return '<p class="text-[10px] text-gray-400 text-center">No comments yet</p>';
        return Object.values(comments).sort((a,b)=>b.timestamp - a.timestamp).map(c => {
            const u = userCache[c.uid] || {fullName: "User"};
            const isV = u.isVerified === true || u.isVerified === "true";
            return `
            <div class="flex gap-2">
                <img src="${u.profilePic || 'https://ui-avatars.com/api/?name='+u.fullName}" class="w-7 h-7 rounded-full cursor-pointer" onclick="location.href='profile.html?uid=${c.uid}'">
                <div class="comment-bubble" onclick="location.href='profile.html?uid=${c.uid}'">
                    <p class="text-[10px] font-bold">${u.fullName || 'User'}${isV ? blueBadge : ""}</p>
                    <p class="text-[11px] text-gray-800 leading-tight">${c.text}</p>
                    <p class="text-[8px] text-gray-400 mt-1">${timeAgo(c.timestamp)}</p>
                </div>
            </div>`;
        }).join('');
    }

    async function handleLike(pid) {
        const ref = db.ref(`posts/${pid}/likedBy/${myUid}`);
        const snap = await ref.get(); snap.exists() ? ref.remove() : ref.set(true);
    }

    async function sendComment(pid) {
        const inp = document.getElementById(`in-${pid}`);
        if(!inp.value.trim()) return;
        await db.ref(`posts/${pid}/comments`).push({ uid: myUid, text: inp.value.trim(), timestamp: Date.now() });
        inp.value = "";
    }

    async function deletePost(pid) {
        Swal.fire({ title: 'Delete Post?', text: "You won't be able to revert this!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Yes, delete it!' }).then(async (result) => {
            if (result.isConfirmed) { await db.ref(`posts/${pid}`).remove(); }
        });
    }

    function toggleBox(id) {
        const el = document.getElementById(`box-${id}`);
        el.classList.toggle('hidden');
        openComments[id] = !el.classList.contains('hidden');
    }

    function listenStatus(uid) {
        db.ref(`status/${uid}`).on('value', snap => {
            const d = snap.val();
            const isOnline = d && (d.state === 'online' || Date.now() < d.last_changed);
            document.getElementById('activeDot').className = `status-indicator ${isOnline ? 'status-online' : ''}`;
            document.getElementById('statusText').innerText = isOnline ? "Active Now" : "Offline";
            document.getElementById('statusText').className = `text-[10px] font-bold uppercase ${isOnline ? 'text-green-600' : 'text-gray-400'}`;
        });
    }

    function renderButtons(uid) {
        const div = document.getElementById('profileActions');
        if (uid === myUid) {
            div.innerHTML = `<button onclick="location.href='settings.html'" class="bg-[#e4e6eb] text-black px-10 py-2 rounded-lg font-bold text-sm">Edit Profile</button>`;
        } else {
            db.ref(`user-following/${myUid}/${uid}`).on('value', s => {
                const isF = s.exists();
                div.innerHTML = `<button onclick="toggleFollow('${uid}', ${isF})" class="px-6 py-2 rounded-lg font-bold text-sm ${isF ? 'bg-gray-200 text-black':'bg-[#1877F2] text-white'}">${isF ? 'Following' : 'Follow'}</button>
                <button onclick="location.href='chat.html?uid=${uid}'" class="bg-gray-200 text-black px-6 py-2 rounded-lg font-bold text-sm">Message</button>`;
            });
        }
    }

    async function toggleFollow(t, isF) {
        if(isF) { await db.ref(`user-following/${myUid}/${t}`).remove(); await db.ref(`user-followers/${t}/${myUid}`).remove(); }
        else { await db.ref(`user-following/${myUid}/${t}`).set(true); await db.ref(`user-followers/${t}/${myUid}`).set(true); }
    }
</script>
</body>
</html>
