<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - SocialTrade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', system-ui, sans-serif; }
        .post-card { background: white; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border: 1px solid #dddfe2; overflow: hidden; }
        .colored-content { min-height: 250px; display: flex; align-items: center; justify-content: center; padding: 30px; text-align: center; font-size: 1.5rem; font-weight: 800; color: white; line-height: 1.2; }
        .text-limit { display: -webkit-box; -webkit-line-clamp: 6; -webkit-box-orient: vertical; overflow: hidden; }
        .read-more-link { color: #65676b; font-weight: 600; cursor: pointer; font-size: 0.9rem; padding: 0 16px 12px; display: block; }
        .profile-header { background: white; border-bottom: 1px solid #dddfe2; }
        .cover-photo { height: 180px; background: linear-gradient(to right, #1877F2, #00C6FF); }
        .profile-pic { width: 110px; height: 110px; border-radius: 50%; border: 4px solid white; margin-top: -55px; object-fit: cover; background: #eee; }
        
        /* SweetAlert Button Styling */
        .swal-edit-btn {
            background: #1877F2;
            color: white;
            padding: 14px;
            border-radius: 12px;
            font-weight: 700;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .swal-edit-btn:hover { background: #145dbf; transform: scale(0.98); }
    </style>
</head>
<body class="pb-10">

    <div class="max-w-[500px] mx-auto">
        <div class="profile-header pb-4 shadow-sm">
            <div class="cover-photo flex items-start p-3">
                <a href="feed.html" class="text-white bg-black/20 w-8 h-8 flex items-center justify-center rounded-full"><i class="fas fa-arrow-left"></i></a>
            </div>
            <div class="px-4 text-center">
                <img id="userPic" src="https://ui-avatars.com/api/?name=User" class="profile-pic mx-auto">
                <h2 id="userName" class="text-2xl font-bold mt-2 text-[#050505]">Loading...</h2>
                <p id="userBio" class="text-gray-500 text-sm italic">User Bio</p>
                
                <div id="profileActions" class="flex gap-2 mt-4 justify-center">
                </div>
            </div>
        </div>

        <div class="p-3">
            <h3 id="feedTitle" class="font-bold text-lg text-[#050505] mb-3">Posts</h3>
            <div id="myPostsContainer">
                <div class="text-center py-20 text-gray-400"><i class="fas fa-spinner fa-spin"></i> Loading Feed...</div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA",
            authDomain: "social-media-5e6c8.firebaseapp.com",
            databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com/",
            projectId: "social-media-5e6c8",
            storageBucket: "social-media-5e6c8.firebasestorage.app",
            messagingSenderId: "897473713729",
            appId: "1:897473713729:web:7ba552ed4c1be8754418c0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        const urlParams = new URLSearchParams(window.location.search);
        let targetUid = urlParams.get('uid');

        auth.onAuthStateChanged(user => {
            if (user) {
                if (!targetUid) targetUid = user.uid;
                const isMyProfile = (targetUid === user.uid);
                setupUI(isMyProfile);
                loadProfile(targetUid);
                loadPosts(targetUid, isMyProfile);
            } else {
                window.location.href = "login.html";
            }
        });

        function setupUI(isMyProfile) {
            const actions = document.getElementById('profileActions');
            if (isMyProfile) {
                actions.innerHTML = `
                    <button onclick="editProfile()" class="bg-[#e4e6eb] text-black px-8 py-2 rounded-lg font-bold text-sm">Edit Profile</button>
                    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-bold text-sm"><i class="fas fa-sign-out-alt"></i></button>
                `;
                document.getElementById('feedTitle').innerText = "My Posts";
            } else {
                actions.innerHTML = `
                    <button onclick="goToChat('${targetUid}')" class="bg-[#1877F2] text-white px-8 py-2 rounded-lg font-bold text-sm">
                        <i class="fas fa-comment-dots mr-2"></i> Message
                    </button>
                `;
                document.getElementById('feedTitle').innerText = "User Posts";
            }
        }

        async function loadProfile(uid) {
            const snap = await db.ref(`user-info/${uid}/profile`).once('value');
            if(snap.exists()) {
                const data = snap.val();
                document.getElementById('userName').innerText = data.fullName || "User";
                document.getElementById('userPic').src = data.profilePic || `https://ui-avatars.com/api/?name=${data.fullName}`;
                document.getElementById('userBio').innerText = data.bio || "No bio available";
            }
        }

        function loadPosts(uid, isMyProfile) {
            db.ref('posts').on('value', snapshot => {
                let posts = [];
                snapshot.forEach(child => {
                    const post = child.val();
                    if(post.uid === uid) posts.push({ id: child.key, ...post });
                });
                posts.sort((a, b) => b.timestamp - a.timestamp);
                renderPosts(posts, isMyProfile);
            });
        }

        function renderPosts(posts, isMyProfile) {
            const container = document.getElementById('myPostsContainer');
            if (posts.length === 0) {
                container.innerHTML = `<div class="bg-white p-10 text-center rounded-lg border text-gray-400">No posts to show.</div>`;
                return;
            }

            container.innerHTML = posts.map(post => {
                const hasBg = post.background && post.background !== "none";
                const isLongText = post.text && post.text.length > 300;
                const limitClass = (!hasBg && isLongText) ? 'text-limit' : '';

                return `
                <div class="post-card">
                    <div class="p-3 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <img src="${post.userPhoto}" class="w-8 h-8 rounded-full border">
                            <p class="font-bold text-sm">${post.userName}</p>
                        </div>
                        ${isMyProfile ? `<button onclick="deletePost('${post.id}')" class="text-gray-400 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button>` : ''}
                    </div>
                    <div id="ptext-${post.id}" class="${hasBg ? 'colored-content' : 'px-4 pb-2 text-[15px] text-[#050505]'} ${limitClass}" 
                         style="background: ${hasBg ? post.background : 'transparent'}">
                        ${post.text}
                    </div>
                    ${(!hasBg && isLongText) ? `<span class="read-more-link" onclick="toggleReadMore('${post.id}', this)">See more</span>` : ''}
                    <div class="px-4 py-3 border-t flex justify-between text-xs text-gray-500 mt-2">
                        <span>${new Date(post.timestamp).toLocaleDateString()}</span>
                        <span>${post.likedBy ? Object.keys(post.likedBy).length : 0} Likes</span>
                    </div>
                </div>`;
            }).join('');
        }

        // --- Modified Edit Profile Function ---
        async function editProfile() {
            Swal.fire({
                title: '<strong>Profile Settings</strong>',
                icon: 'info',
                html: `
                    <div class="p-2">
                        <p class="text-gray-500 text-sm mb-6">Click below to update your name, photo, and other personal details.</p>
                        <button onclick="window.location.href='editprofile.html'" class="swal-edit-btn">
                            <i class="fas fa-user-cog"></i> Personal Information
                        </button>
                    </div>
                `,
                showConfirmButton: false,
                showCloseButton: true,
                customClass: {
                    popup: 'rounded-3xl shadow-2xl'
                }
            });
        }

        function logout() {
            auth.signOut().then(() => window.location.href = "login.html");
        }

        // Other functions (toggleReadMore, deletePost, etc.) remain the same
        function toggleReadMore(postId, btn) {
            const el = document.getElementById(`ptext-${postId}`);
            const isCollapsed = el.classList.contains('text-limit');
            el.classList.toggle('text-limit');
            btn.innerText = isCollapsed ? "See less" : "See more";
        }
        async function deletePost(pid) {
            const res = await Swal.fire({ text: 'Delete this post?', icon: 'warning', showCancelButton: true });
            if (res.isConfirmed) await db.ref(`posts/${pid}`).remove();
        }
    </script>
    <script>// 1. Script-er ekdom upore eiti add koro (jodi age theke na thake)
const blueBadge = `<svg class="inline-block w-[18px] h-[18px] ml-1 mb-1 text-[#1877F2]" viewBox="0 0 24 24" fill="currentColor"><path d="M9.707 19.121a.997.997 0 01-1.414 0l-5.646-5.647a1.5 1.5 0 010-2.121l.707-.707a1.5 1.5 0 012.121 0L9 14.167l8.528-8.527a1.5 1.5 0 012.122 0l.707.707a1.5 1.5 0 010 2.121l-9.944 9.944a1 1 0 01-.706.709z" /></svg>`;

// 2. Profile Header-e Badge add korar jonno loadProfile function update:
async function loadProfile(uid) {
    const snap = await db.ref(`user-info/${uid}/profile`).once('value');
    if(snap.exists()) {
        const data = snap.val();
        
        // Check if user is verified
        const verifiedIcon = data.isVerified ? blueBadge : "";
        
        // innerHTML bebohar kora hoyeche jate SVG icon show kore
        document.getElementById('userName').innerHTML = (data.fullName || "User") + verifiedIcon;
        document.getElementById('userPic').src = data.profilePic || `https://ui-avatars.com/api/?name=${data.fullName}`;
        document.getElementById('userBio').innerText = data.bio || "No bio available";
    }
}

// 3. Post-er namer pashe badge add korar jonno renderPosts function update:
function renderPosts(posts, isMyProfile) {
    const container = document.getElementById('myPostsContainer');
    if (posts.length === 0) {
        container.innerHTML = `<div class="bg-white p-10 text-center rounded-lg border text-gray-400">No posts to show.</div>`;
        return;
    }

    // Prothome oi user-er verification status niye ashi (jehetu eta tar profile)
    db.ref(`user-info/${targetUid}/profile/isVerified`).once('value', (vSnap) => {
        const isVerified = vSnap.val() || false;
        const verifiedIcon = isVerified ? blueBadge : "";

        container.innerHTML = posts.map(post => {
            const hasBg = post.background && post.background !== "none";
            const isLongText = post.text && post.text.length > 300;
            const limitClass = (!hasBg && isLongText) ? 'text-limit' : '';

            return `
            <div class="post-card">
                <div class="p-3 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <img src="${post.userPhoto}" class="w-8 h-8 rounded-full border">
                        <p class="font-bold text-sm">${post.userName}${verifiedIcon}</p>
                    </div>
                    ${isMyProfile ? `<button onclick="deletePost('${post.id}')" class="text-gray-400 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button>` : ''}
                </div>
                <div id="ptext-${post.id}" class="${hasBg ? 'colored-content' : 'px-4 pb-2 text-[15px] text-[#050505]'} ${limitClass}" 
                     style="background: ${hasBg ? post.background : 'transparent'}">
                    ${post.text}
                </div>
                ${(!hasBg && isLongText) ? `<span class="read-more-link" onclick="toggleReadMore('${post.id}', this)">See more</span>` : ''}
                <div class="px-4 py-3 border-t flex justify-between text-xs text-gray-500 mt-2">
                    <span>${new Date(post.timestamp).toLocaleDateString()}</span>
                    <span>${post.likedBy ? Object.keys(post.likedBy).length : 0} Likes</span>
                </div>
            </div>`;
        }).join('');
    });
}</script>
</body>
</html>