<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>User Profile - SocialTrade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', system-ui, sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        .post-card { background: white; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border: 1px solid #dddfe2; }
        .colored-content { min-height: 250px; display: flex; align-items: center; justify-content: center; padding: 30px; text-align: center; font-size: 1.5rem; font-weight: 800; color: white; border-radius: 4px; }
        .profile-pic { width: 120px; height: 120px; border-radius: 50%; border: 4px solid white; margin-top: -60px; object-fit: cover; background: #eee; }
        .comment-bubble { background: #f0f2f5; border-radius: 18px; padding: 8px 15px; max-width: 85%; transition: all 0.2s; }
        .comment-bubble:active { background: #e4e6eb; }
        
        #pushNotification { position: fixed; top: -250px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 450px; z-index: 99999; transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #pushNotification.show { top: 20px; }
    </style>

    <script>
        // ðŸ›¡ï¸ Advanced Anti-Inspect & Security
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.onkeydown = function(e) {
            if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 67 || e.keyCode == 74)) || (e.ctrlKey && e.keyCode == 85)) return false;
        };
        // Disable dragging of images
        document.ondragstart = () => false;
        // Debugger Trap
        setInterval(() => { (function() { return false; }['constructor']('debugger')['call']()); }, 100);
    </script>
</head>
<body class="pb-10">

    <div id="pushNotification">
        <div class="bg-white rounded-[25px] p-4 shadow-2xl border flex items-center gap-4 cursor-pointer" onclick="openChatFromNotif()">
            <img id="notifImg" src="" class="w-12 h-12 rounded-full border-2 border-blue-500">
            <div class="flex-1 overflow-hidden">
                <span id="notifName" class="font-bold text-gray-800">User</span>
                <p id="notifMsg" class="text-sm text-gray-500 truncate">Message preview...</p>
            </div>
        </div>
    </div>

    <div id="profileWrapper" class="max-w-[500px] mx-auto">
        <div class="bg-white border-b pb-4 shadow-sm">
            <div class="h-40 bg-gradient-to-r from-[#1877F2] to-[#00C6FF] p-3">
                <button onclick="history.back()" class="text-white bg-black/20 w-8 h-8 flex items-center justify-center rounded-full"><i class="fas fa-arrow-left"></i></button>
            </div>
            <div class="px-4 text-center">
                <img id="userPic" src="" class="profile-pic mx-auto shadow-md">
                <h2 id="userName" class="text-2xl font-bold mt-2 text-[#050505] flex items-center justify-center">Loading...</h2>
                <p id="followerDisplay" class="text-[#1877F2] font-bold text-sm mb-1">0 Followers</p>
                <p id="userBio" class="text-gray-500 text-sm italic px-6">...</p>
                <div id="profileActions" class="flex gap-2 mt-4 justify-center"></div>
            </div>
        </div>

        <div class="p-3">
            <h3 class="font-bold text-lg text-[#050505] mb-3 border-b pb-2">User Posts</h3>
            <div id="myPostsContainer">
                <div class="text-center py-20 text-gray-400"><i class="fas fa-circle-notch fa-spin"></i></div>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA", authDomain: "social-media-5e6c8.firebaseapp.com", databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com/", projectId: "social-media-5e6c8" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), auth = firebase.auth();

    const blueBadge = `<svg class="inline-block w-4 h-4 ml-1 mb-0.5 text-[#1877F2]" viewBox="0 0 24 24" fill="currentColor"><path d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.7l-3.61.81.34 3.7L1 12l2.44 2.79-.34 3.69 3.61.82 1.89 3.2L12 21.04l3.4 1.46 1.89-3.2 3.61-.82-.34-3.69L23 12zm-12.91 4.72l-3.8-3.81 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48-7.33 7.35z"/></svg>`;
    const urlParams = new URLSearchParams(window.location.search);
    let targetUid = urlParams.get('uid'), myUid = "", userCache = {}, openComments = {};

    function timeAgo(ts) {
        const s = Math.floor((Date.now() - ts) / 1000);
        if (s < 60) return "Just now";
        if (s < 3600) return Math.floor(s/60) + "m";
        if (s < 86400) return Math.floor(s/3600) + "h";
        return Math.floor(s/86400) + "d";
    }

    // ðŸŸ¢ à§© à¦®à¦¿à¦¨à¦¿à¦Ÿ à¦…à¦¨à¦²à¦¾à¦‡à¦¨ à¦²à¦œà¦¿à¦• (Ager Moto)
    function keepActive() {
        if(!myUid) return;
        db.ref(`status/${myUid}`).set({ state: 'online', last_changed: Date.now() + 180000 });
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            myUid = user.uid;
            keepActive(); setInterval(keepActive, 60000);
            if (!targetUid) targetUid = myUid;

            // à¦¬à§à¦²à¦•à¦¡ à¦‡à¦‰à¦œà¦¾à¦° à¦šà§‡à¦•
            db.ref(`user-info/${myUid}/profile/status`).on('value', snap => {
                if (snap.val() === 'blocked') window.location.href = "error.html";
            });

            // à¦•à§à¦¯à¦¾à¦¶ à¦¡à¦¾à¦Ÿà¦¾ à¦²à§‹à¦¡ (à¦•à¦®à§‡à¦¨à§à¦Ÿà§‡ à¦‡à¦‰à¦œà¦¾à¦° à¦‡à¦¨à¦«à§‹ à¦¦à§‡à¦–à¦¾à¦¨à§‹à¦° à¦œà¦¨à§à¦¯)
            db.ref('user-info').on('value', snap => {
                snap.forEach(u => { userCache[u.key] = u.val().profile; });
                loadProfile(targetUid);
                loadPosts(targetUid);
            });
            listenNotifications();
        } else { window.location.href = "login.html"; }
    });

    function loadProfile(uid) {
        db.ref(`user-info/${uid}/profile`).on('value', snap => {
            const data = snap.val(); if(!data) return;
            document.getElementById('userName').innerHTML = data.fullName + (data.isVerified ? blueBadge : "");
            document.getElementById('userPic').src = data.profilePic || `https://ui-avatars.com/api/?name=${data.fullName}`;
            document.getElementById('userBio').innerText = data.bio || "No bio available";
            loadFollowers(uid);
            renderActionButtons(uid);
        });
    }

    function renderActionButtons(uid) {
        const div = document.getElementById('profileActions');
        if (uid === myUid) {
            div.innerHTML = `<button onclick="location.href='settings.html'" class="bg-[#e4e6eb] text-black px-10 py-2 rounded-lg font-bold text-sm active:scale-95 transition">Edit Profile</button>`;
        } else {
            db.ref(`user-following/${myUid}/${uid}`).on('value', s => {
                const isF = s.exists();
                div.innerHTML = `
                    <button onclick="toggleFollow('${uid}', ${isF})" class="px-6 py-2 rounded-lg font-bold text-sm active:scale-95 transition ${isF ? 'bg-gray-200 text-black':'bg-[#1877F2] text-white'}">${isF ? 'Following' : 'Follow'}</button>
                    <button onclick="location.href='chat.html?uid=${uid}'" class="bg-gray-200 text-black px-6 py-2 rounded-lg font-bold text-sm active:scale-95 transition">Message</button>`;
            });
        }
    }

    function loadPosts(uid) {
        db.ref('posts').on('value', snap => {
            let posts = [];
            snap.forEach(c => { if(c.val().uid === uid) posts.push({id: c.key, ...c.val()}); });
            renderFeed(posts.sort((a,b)=>b.timestamp - a.timestamp));
        });
    }

    function renderFeed(posts) {
        const container = document.getElementById('myPostsContainer');
        if(posts.length === 0) { container.innerHTML = `<div class="text-center py-10 text-gray-400">No posts.</div>`; return; }
        
        container.innerHTML = posts.map(post => {
            const isLiked = post.likedBy && post.likedBy[myUid];
            const author = userCache[post.uid] || {};
            const isHidden = openComments[post.id] ? '' : 'hidden';

            return `
            <div class="post-card">
                <div class="p-3 flex items-center gap-2 border-b mx-1">
                    <img src="${author.profilePic || 'https://ui-avatars.com/api/?name='+author.fullName}" class="w-9 h-9 rounded-full border">
                    <div>
                        <p class="font-bold text-sm">${author.fullName}${author.isVerified ? blueBadge : ""}</p>
                        <p class="text-[10px] text-gray-400">${timeAgo(post.timestamp)}</p>
                    </div>
                </div>
                <div class="${post.background && post.background !== 'none' ? 'colored-content' : 'px-4 py-3 text-sm'}" style="background: ${post.background || 'transparent'}">
                    ${post.text}
                </div>
                <div class="px-4 py-2 flex justify-between text-gray-500 text-[11px] border-b mx-2">
                    <span><i class="fas fa-thumbs-up text-blue-500"></i> ${post.likedBy ? Object.keys(post.likedBy).length : 0}</span>
                    <span onclick="toggleBox('${post.id}')" class="cursor-pointer hover:underline">${post.comments ? Object.keys(post.comments).length : 0} comments</span>
                </div>
                <div class="flex p-1">
                    <button onclick="handleLike('${post.id}')" class="flex-1 py-2 text-sm font-semibold flex items-center justify-center gap-2 ${isLiked ? 'text-blue-600': 'text-gray-500'}"><i class="${isLiked?'fas':'far'} fa-thumbs-up"></i> Like</button>
                    <button onclick="toggleBox('${post.id}')" class="flex-1 py-2 text-sm font-semibold flex items-center justify-center gap-2 text-gray-500"><i class="far fa-comment"></i> Comment</button>
                </div>
                <div id="box-${post.id}" class="${isHidden} border-t bg-gray-50 p-2">
                    <div class="space-y-3 mb-2 max-h-60 overflow-y-auto">${renderComments(post.comments)}</div>
                    <div class="flex gap-2 p-1">
                        <input type="text" id="in-${post.id}" placeholder="Write a comment..." class="flex-1 bg-white border rounded-full px-4 py-1.5 text-xs outline-none focus:border-blue-400">
                        <button onclick="sendComment('${post.id}')" class="text-blue-600 px-2"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    // ðŸš€ à¦•à¦®à§‡à¦¨à§à¦Ÿ à¦²à¦œà¦¿à¦•: à¦¨à¦¤à§à¦¨ à¦•à¦®à§‡à¦¨à§à¦Ÿ à¦¸à¦¬à¦¾à¦° à¦†à¦—à§‡ à¦†à¦¸à¦¬à§‡ à¦à¦¬à¦‚ à¦ªà§à¦°à§‹à¦«à¦¾à¦‡à¦²à§‡ à¦¯à¦¾à¦“à§Ÿà¦¾ à¦¯à¦¾à¦¬à§‡
    function renderComments(comments) {
        if(!comments) return '';
        // sort((a,b)=> b.timestamp - a.timestamp) à¦¦à¦¿à§Ÿà§‡ à¦²à§‡à¦Ÿà§‡à¦¸à§à¦Ÿ à¦•à¦®à§‡à¦¨à§à¦Ÿ à¦‰à¦ªà¦°à§‡ à¦†à¦¨à¦¾ à¦¹à§Ÿà§‡à¦›à§‡
        return Object.values(comments).sort((a,b)=> b.timestamp - a.timestamp).map(c => {
            const cUser = userCache[c.uid] || {fullName: "User"};
            return `
            <div class="flex gap-2">
                <img src="${cUser.profilePic || 'https://ui-avatars.com/api/?name='+cUser.fullName}" 
                     class="w-7 h-7 rounded-full cursor-pointer" onclick="location.href='profile.html?uid=${c.uid}'">
                <div class="comment-bubble">
                    <p class="text-[10px] font-bold cursor-pointer hover:underline" onclick="location.href='profile.html?uid=${c.uid}'">
                        ${cUser.fullName}${cUser.isVerified ? blueBadge : ""}
                    </p>
                    <p class="text-[12px] text-gray-800 leading-tight">${c.text}</p>
                    <p class="text-[8px] text-gray-400 mt-1">${timeAgo(c.timestamp)}</p>
                </div>
            </div>`;
        }).join('');
    }

    async function sendComment(pid) {
        const inp = document.getElementById(`in-${pid}`);
        if(!inp.value.trim()) return;
        await db.ref(`posts/${pid}/comments`).push({
            uid: myUid,
            text: inp.value.trim(),
            timestamp: Date.now()
        });
        inp.value = "";
    }

    function toggleBox(id) { 
        const el = document.getElementById(`box-${id}`);
        el.classList.toggle('hidden');
        openComments[id] = !el.classList.contains('hidden');
    }

    async function handleLike(pid) {
        const ref = db.ref(`posts/${pid}/likedBy/${myUid}`);
        const snap = await ref.get();
        snap.exists() ? ref.remove() : ref.set(true);
    }

    async function toggleFollow(t, isF) {
        if(isF) {
            await db.ref(`user-following/${myUid}/${t}`).remove();
            await db.ref(`user-followers/${t}/${myUid}`).remove();
        } else {
            await db.ref(`user-following/${myUid}/${t}`).set(true);
            await db.ref(`user-followers/${t}/${myUid}`).set(true);
        }
    }

    function loadFollowers(uid) {
        db.ref(`user-followers/${uid}`).on('value', snap => {
            document.getElementById('followerDisplay').innerText = `${snap.numChildren()} Followers`;
        });
    }

    function listenNotifications() {
        db.ref('chats').on('child_added', snap => {
            if (snap.key.includes(myUid)) {
                db.ref(`chats/${snap.key}`).limitToLast(1).on('child_added', async mSnap => {
                    const m = mSnap.val();
                    if (m.senderId !== myUid && !localStorage.getItem('saw_' + mSnap.key)) {
                        localStorage.setItem('saw_' + mSnap.key, 'true');
                        const sender = userCache[m.senderId] || {fullName: "User"};
                        document.getElementById('notifImg').src = sender.profilePic || 'https://ui-avatars.com/api/?name='+sender.fullName;
                        document.getElementById('notifName').innerText = sender.fullName;
                        document.getElementById('notifMsg').innerText = m.text;
                        document.getElementById('pushNotification').classList.add('show');
                        setTimeout(() => document.getElementById('pushNotification').classList.remove('show'), 5000);
                    }
                });
            }
        });
    }
</script>
</body>
</html>
