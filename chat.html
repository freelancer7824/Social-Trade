<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat - SocialTrade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        body { user-select: none; -webkit-tap-highlight-color: transparent; background-color: #fff; overflow: hidden; font-family: sans-serif; }
        #messages::-webkit-scrollbar { width: 4px; }
        #messages::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .img-container { width: 220px; height: 280px; border-radius: 18px; overflow: hidden; background: #f0f0f0; cursor: pointer; border: 1px solid #eee; }
        .img-container img { width: 100%; height: 100%; object-fit: cover; display: block; }
        #imgModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center; }
        #imgModal img { max-width: 95%; max-height: 85%; border-radius: 8px; }
        .upload-loader { border: 2px solid #f3f3f3; border-top: 2px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .recording-active { color: #ef4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        audio { height: 35px; max-width: 200px; border-radius: 20px; }
    </style>

    <script>
        // ðŸ›¡ï¸ Safe Anti-Inspect (à¦¬à§à¦Ÿ à¦²à§à¦ª à¦¹à¦¬à§‡ à¦¨à¦¾)
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.onkeydown = function(e) {
            if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && [73, 74, 67].includes(e.keyCode)) || (e.ctrlKey && e.keyCode == 85)) {
                return false;
            }
        };
    </script>
</head>
<body class="max-w-[500px] mx-auto h-screen flex flex-col bg-white">

    <div class="p-4 border-b flex items-center gap-3 bg-white sticky top-0 z-10">
        <i class="fas fa-arrow-left text-blue-500 text-lg cursor-pointer p-1" onclick="window.history.back()"></i>
        <img id="headPic" class="w-10 h-10 rounded-full object-cover border" src="https://ui-avatars.com/api/?name=User">
        <div class="flex-1">
            <h2 id="headName" class="font-bold text-[15px] text-gray-900">Loading...</h2>
            <div id="headStatus" class="text-[10px] flex items-center gap-1 text-gray-400">
                <span id="statusDot" class="w-2.5 h-2.5 rounded-full bg-gray-300"></span>
                <span id="statusText">Checking...</span>
            </div>
        </div>
    </div>

    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50"></div>

    <div id="voiceStatus" class="hidden px-4 py-3 bg-blue-50 text-blue-600 text-sm flex justify-between items-center border-t animate-pulse">
        <span class="flex items-center gap-2">
            <i class="fas fa-microphone text-red-500"></i> 
            Recording... <span id="timer" class="font-mono font-bold">0s</span>
        </span>
        <button onclick="stopAndCancel()" class="text-red-500 font-bold px-2">Cancel</button>
    </div>

    <div class="p-3 border-t bg-white flex gap-2 items-center">
        <label class="p-2 cursor-pointer active:scale-90 transition">
            <i class="fas fa-image text-blue-500 text-xl" id="camIcon"></i>
            <div id="uploadSpin" class="upload-loader hidden"></div>
            <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="uploadToCloudinary(this)">
        </label>
        
        <button id="voiceBtn" onclick="toggleRecording()" class="p-2 text-blue-500 active:scale-90 transition">
            <i class="fas fa-microphone text-xl"></i>
        </button>

        <input id="msgInput" type="text" placeholder="Aa" class="flex-1 bg-gray-100 rounded-full px-5 py-2.5 outline-none text-sm border focus:border-blue-300 transition" autocomplete="off" onkeypress="if(event.key==='Enter')sendMsg()">
        
        <button onclick="sendMsg()" id="sendBtn" class="text-blue-500 p-2 font-bold active:scale-90 transition">
            <i class="fas fa-paper-plane text-xl"></i>
        </button>
    </div>

    <div id="imgModal" onclick="this.style.display='none'">
        <img id="fullImg" src="">
    </div>

    <script>
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dhvtgzy5x/auto/upload";
        const CLOUDINARY_PRESET = "Rosenews"; 

        const firebaseConfig = { 
            apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA", 
            authDomain: "social-media-5e6c8.firebaseapp.com", 
            databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com/", 
            projectId: "social-media-5e6c8" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(), auth = firebase.auth();
        const urlParams = new URLSearchParams(window.location.search);
        const receiverId = urlParams.get('uid');
        let myUid = "", chatKey = "";

        let mediaRecorder, audioChunks = [], timerInterval, seconds = 0, isRecording = false, shouldUpload = false;

        auth.onAuthStateChanged(user => {
            if (user && receiverId) {
                myUid = user.uid;
                chatKey = myUid < receiverId ? myUid + "_" + receiverId : receiverId + "_" + myUid;
                loadHeader();
                loadMessages();
            }
        });

        function loadHeader() {
            db.ref(`user-info/${receiverId}/profile`).on('value', s => {
                const u = s.val() || {};
                document.getElementById('headName').innerText = u.fullName || "User";
                document.getElementById('headPic').src = u.profilePic || 'https://ui-avatars.com/api/?name=User';
            });
            db.ref(`status/${receiverId}`).on('value', s => {
                const data = s.val();
                const isOnline = data && (data.state === 'online');
                document.getElementById('statusText').innerText = isOnline ? "Active now" : "Offline";
                document.getElementById('statusDot').className = `w-2.5 h-2.5 rounded-full ${isOnline ? 'bg-green-500 shadow-[0_0_5px_#22c55e]' : 'bg-gray-300'}`;
            });
        }

        function loadMessages() {
            db.ref(`chats/${chatKey}`).on('value', snap => {
                const msgs = snap.val() || {};
                const container = document.getElementById('messages');
                container.innerHTML = Object.values(msgs).map(m => {
                    const isMe = m.senderId === myUid;
                    let content = "";
                    if(m.type === 'image') {
                        content = `<div class="img-container" onclick="openFullImage('${m.text}')"><img src="${m.text}" loading="lazy"></div>`;
                    } else if(m.type === 'voice') {
                        content = `<div class="flex items-center bg-white p-1 rounded-full shadow-sm border"><audio controls src="${m.text}"></audio></div>`;
                    } else {
                        content = `<div class="px-4 py-2.5 rounded-2xl text-[14px] shadow-sm ${isMe ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white text-gray-800 border border-gray-100 rounded-bl-none'}">${m.text}</div>`;
                    }
                    return `<div class="flex ${isMe ? 'justify-end' : 'justify-start'}"><div class="max-w-[85%]">${content}</div></div>`;
                }).join('');
                container.scrollTop = container.scrollHeight;
            });
        }

        async function toggleRecording() {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    startRecording(stream);
                } catch (err) { alert("Mic permission error!"); }
            } else { stopAndSend(); }
        }

        function startRecording(stream) {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = []; isRecording = true; shouldUpload = true; seconds = 0;
            mediaRecorder.ondataavailable = e => { if(e.data.size > 0) audioChunks.push(e.data); };
            mediaRecorder.onstop = async () => {
                if (shouldUpload && audioChunks.length > 0) {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                    uploadAudio(audioBlob);
                }
                stream.getTracks().forEach(track => track.stop());
            };
            mediaRecorder.start();
            document.getElementById('voiceStatus').classList.remove('hidden');
            document.getElementById('voiceBtn').classList.add('recording-active');
            timerInterval = setInterval(() => {
                seconds++;
                document.getElementById('timer').innerText = seconds + "s";
                if (seconds >= 60) stopAndSend();
            }, 1000);
        }

        function stopAndSend() {
            if (isRecording) {
                shouldUpload = true; isRecording = false;
                mediaRecorder.stop(); resetUI();
            }
        }

        function stopAndCancel() {
            if (isRecording) {
                shouldUpload = false; isRecording = false;
                mediaRecorder.stop(); resetUI();
            }
        }

        function resetUI() {
            clearInterval(timerInterval);
            document.getElementById('voiceStatus').classList.add('hidden');
            document.getElementById('voiceBtn').classList.remove('recording-active');
            document.getElementById('timer').innerText = "0s";
        }

        async function uploadAudio(blob) {
            const formData = new FormData();
            formData.append("file", blob);
            formData.append("upload_preset", CLOUDINARY_PRESET);
            try {
                const res = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
                const data = await res.json();
                if (data.secure_url) {
                    db.ref(`chats/${chatKey}`).push({ senderId: myUid, text: data.secure_url, type: 'voice', timestamp: Date.now() });
                }
            } catch (e) { alert("Voice send failed!"); }
        }

        function sendMsg() {
            const input = document.getElementById('msgInput');
            const txt = input.value.trim();
            if (isRecording) { stopAndSend(); return; }
            if(!txt) return;
            db.ref(`chats/${chatKey}`).push({ senderId: myUid, text: txt, type: 'text', timestamp: Date.now() });
            input.value = "";
        }

        async function uploadToCloudinary(input) {
            if (!input.files[0]) return;
            document.getElementById('camIcon').classList.add('hidden');
            document.getElementById('uploadSpin').classList.remove('hidden');
            const formData = new FormData();
            formData.append("file", input.files[0]);
            formData.append("upload_preset", CLOUDINARY_PRESET);
            try {
                const res = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
                const data = await res.json();
                if (data.secure_url) {
                    db.ref(`chats/${chatKey}`).push({ senderId: myUid, text: data.secure_url, type: 'image', timestamp: Date.now() });
                }
            } catch (e) { alert("Upload failed!"); }
            finally {
                document.getElementById('camIcon').classList.remove('hidden');
                document.getElementById('uploadSpin').classList.add('hidden');
                input.value = "";
            }
        }

        function openFullImage(url) {
            document.getElementById('fullImg').src = url;
            document.getElementById('imgModal').style.display = 'flex';
        }
    </script>
</body>
</html>
